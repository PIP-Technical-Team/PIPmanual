<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 12 Docker Container | PIP Manual</title>
  <meta name="description" content="These are the guidelines to all the technical decisions taken during the creation of packges for the PIP workflow." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 12 Docker Container | PIP Manual" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="These are the guidelines to all the technical decisions taken during the creation of packges for the PIP workflow." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 12 Docker Container | PIP Manual" />
  
  <meta name="twitter:description" content="These are the guidelines to all the technical decisions taken during the creation of packges for the PIP workflow." />
  

<meta name="author" content="DECIS" />
<meta name="author" content="Poverty GP" />


<meta name="date" content="2022-03-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="load.html"/>
<link rel="next" href="azure.html"/>
<script src="libs/header-attrs-2.13/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.21/datatables.js"></script>
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="https://unpkg.com/tachyons@4/css/tachyons.min.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/r-colors.css" type="text/css" />
<link rel="stylesheet" href="css/smltar.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">PIP Internal Guidelines</a></strong></li>

<li class="divider"></li>
<li><a href="index.html#welcome">Welcome!<span></span></a>
<ul>
<li><a href="index.html#team">Team<span></span></a></li>
</ul></li>
<li class="part"><span><b>I Introduction<span></span></b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction<span></span></a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#ojectives"><i class="fa fa-check"></i><b>1.1</b> Ojectives<span></span></a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#technical-requirements"><i class="fa fa-check"></i><b>1.2</b> Technical requirements<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="internal-workflow.html"><a href="internal-workflow.html"><i class="fa fa-check"></i><b>2</b> Internal Workflow<span></span></a>
<ul>
<li class="chapter" data-level="2.1" data-path="internal-workflow.html"><a href="internal-workflow.html#the-github-group"><i class="fa fa-check"></i><b>2.1</b> The Github group<span></span></a></li>
<li class="chapter" data-level="2.2" data-path="internal-workflow.html"><a href="internal-workflow.html#overview"><i class="fa fa-check"></i><b>2.2</b> Overview<span></span></a></li>
<li class="chapter" data-level="2.3" data-path="internal-workflow.html"><a href="internal-workflow.html#data-acquisition"><i class="fa fa-check"></i><b>2.3</b> Data acquisition<span></span></a></li>
<li class="chapter" data-level="2.4" data-path="internal-workflow.html"><a href="internal-workflow.html#data-preparation"><i class="fa fa-check"></i><b>2.4</b> Data preparation<span></span></a></li>
<li class="chapter" data-level="2.5" data-path="internal-workflow.html"><a href="internal-workflow.html#pre-computed-indicators"><i class="fa fa-check"></i><b>2.5</b> Pre-computed indicators<span></span></a></li>
<li class="chapter" data-level="2.6" data-path="internal-workflow.html"><a href="internal-workflow.html#api-feeding"><i class="fa fa-check"></i><b>2.6</b> API feeding<span></span></a></li>
<li class="chapter" data-level="2.7" data-path="internal-workflow.html"><a href="internal-workflow.html#packages-interaction"><i class="fa fa-check"></i><b>2.7</b> Packages interaction<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="folder-structure.html"><a href="folder-structure.html"><i class="fa fa-check"></i><b>3</b> Folder Structure<span></span></a>
<ul>
<li class="chapter" data-level="3.1" data-path="folder-structure.html"><a href="folder-structure.html#pip-data"><i class="fa fa-check"></i><b>3.1</b> PIP-Data<span></span></a></li>
<li class="chapter" data-level="3.2" data-path="folder-structure.html"><a href="folder-structure.html#pip-data_qa"><i class="fa fa-check"></i><b>3.2</b> PIP-Data_QA<span></span></a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="folder-structure.html"><a href="folder-structure.html#aux"><i class="fa fa-check"></i><b>3.2.1</b> _aux<span></span></a></li>
<li class="chapter" data-level="3.2.2" data-path="folder-structure.html"><a href="folder-structure.html#inventory"><i class="fa fa-check"></i><b>3.2.2</b> _inventory<span></span></a></li>
<li class="chapter" data-level="3.2.3" data-path="folder-structure.html"><a href="folder-structure.html#country-data"><i class="fa fa-check"></i><b>3.2.3</b> Country data<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="folder-structure.html"><a href="folder-structure.html#pip-data_extsol"><i class="fa fa-check"></i><b>3.3</b> PIP-Data_ExtSOL<span></span></a></li>
<li class="chapter" data-level="3.4" data-path="folder-structure.html"><a href="folder-structure.html#pip_data_testing"><i class="fa fa-check"></i><b>3.4</b> PIP_Data_Testing<span></span></a></li>
<li class="chapter" data-level="3.5" data-path="folder-structure.html"><a href="folder-structure.html#pip_data_vintage"><i class="fa fa-check"></i><b>3.5</b> PIP_Data_Vintage<span></span></a></li>
<li class="chapter" data-level="3.6" data-path="folder-structure.html"><a href="folder-structure.html#pip_ingestion_pipeline"><i class="fa fa-check"></i><b>3.6</b> pip_ingestion_pipeline<span></span></a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="folder-structure.html"><a href="folder-structure.html#pc_data"><i class="fa fa-check"></i><b>3.6.1</b> pc_data<span></span></a></li>
<li class="chapter" data-level="3.6.2" data-path="folder-structure.html"><a href="folder-structure.html#tb_data"><i class="fa fa-check"></i><b>3.6.2</b> tb_data<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="joining-data.html"><a href="joining-data.html"><i class="fa fa-check"></i><b>4</b> Joining Data<span></span></a>
<ul>
<li class="chapter" data-level="4.1" data-path="joining-data.html"><a href="joining-data.html#pfw-join"><i class="fa fa-check"></i><b>4.1</b> The Price FrameWork (pfw) data<span></span></a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="joining-data.html"><a href="joining-data.html#joining-data-example"><i class="fa fa-check"></i><b>4.1.1</b> Joining data example<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="joining-data.html"><a href="joining-data.html#special-data-cases"><i class="fa fa-check"></i><b>4.2</b> Special data cases<span></span></a></li>
</ul></li>
<li class="part"><span><b>II PIP data<span></span></b></span></li>
<li class="chapter" data-level="5" data-path="pfw-chapter.html"><a href="pfw-chapter.html"><i class="fa fa-check"></i><b>5</b> Price FrameWork (pfw) data frame<span></span></a>
<ul>
<li class="chapter" data-level="5.1" data-path="pfw-chapter.html"><a href="pfw-chapter.html#variables"><i class="fa fa-check"></i><b>5.1</b> Variables<span></span></a></li>
<li class="chapter" data-level="5.2" data-path="pfw-chapter.html"><a href="pfw-chapter.html#additional-explanation"><i class="fa fa-check"></i><b>5.2</b> Additional explanation<span></span></a>
<ul>
<li><a href="pfw-chapter.html#id-vars">ID vars<span></span></a></li>
<li><a href="pfw-chapter.html#altname"><code>altname</code><span></span></a></li>
<li><a href="pfw-chapter.html#survey_coverage"><code>survey_coverage</code><span></span></a></li>
<li><a href="pfw-chapter.html#welfare_type"><code>welfare_type</code><span></span></a></li>
<li><a href="pfw-chapter.html#use_imputed"><code>use_imputed</code><span></span></a></li>
<li><a href="pfw-chapter.html#use_microdata"><code>use_microdata</code><span></span></a></li>
<li><a href="pfw-chapter.html#use_bin"><code>use_bin</code><span></span></a></li>
<li><a href="pfw-chapter.html#use_groupdata"><code>use_groupdata</code><span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="primus.html"><a href="primus.html"><i class="fa fa-check"></i><b>6</b> PRIMUS<span></span></a>
<ul>
<li class="chapter" data-level="6.1" data-path="primus.html"><a href="primus.html#interacting-with-primus"><i class="fa fa-check"></i><b>6.1</b> Interacting with PRIMUS<span></span></a>
<ul>
<li><a href="primus.html#website-platform">Website platform<span></span></a></li>
<li><a href="primus.html#stata-command">Stata command<span></span></a></li>
<li><a href="primus.html#corrections-to-primus-stata-command">Corrections to <code>primus</code> Stata command<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="primus.html"><a href="primus.html#understand-primus"><i class="fa fa-check"></i><b>6.2</b> Understanding PRIMUS<span></span></a></li>
<li class="chapter" data-level="6.3" data-path="primus.html"><a href="primus.html#checking-primus-estimates"><i class="fa fa-check"></i><b>6.3</b> Checking PRIMUS estimates<span></span></a></li>
<li class="chapter" data-level="6.4" data-path="primus.html"><a href="primus.html#approve-primus"><i class="fa fa-check"></i><b>6.4</b> Confirming and approving data in PRIMUS<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="welfare-data.html"><a href="welfare-data.html"><i class="fa fa-check"></i><b>7</b> Welfare data<span></span></a>
<ul>
<li class="chapter" data-level="7.1" data-path="welfare-data.html"><a href="welfare-data.html#welfare-origin-of-data"><i class="fa fa-check"></i><b>7.1</b> From Raw to GMD<span></span></a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="welfare-data.html"><a href="welfare-data.html#microdata"><i class="fa fa-check"></i><b>7.1.1</b> Microdata<span></span></a></li>
<li class="chapter" data-level="7.1.2" data-path="welfare-data.html"><a href="welfare-data.html#group-data"><i class="fa fa-check"></i><b>7.1.2</b> Group Data<span></span></a></li>
<li class="chapter" data-level="7.1.3" data-path="welfare-data.html"><a href="welfare-data.html#bin-data"><i class="fa fa-check"></i><b>7.1.3</b> Bin Data<span></span></a></li>
<li class="chapter" data-level="7.1.4" data-path="welfare-data.html"><a href="welfare-data.html#synthetic-data"><i class="fa fa-check"></i><b>7.1.4</b> Synthetic Data<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="welfare-data.html"><a href="welfare-data.html#from-gmd-to-pip"><i class="fa fa-check"></i><b>7.2</b> From GMD to PIP ({pipdp} package)<span></span></a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="welfare-data.html"><a href="welfare-data.html#requirements"><i class="fa fa-check"></i><b>7.2.1</b> Requirements<span></span></a></li>
<li class="chapter" data-level="7.2.2" data-path="welfare-data.html"><a href="welfare-data.html#installation"><i class="fa fa-check"></i><b>7.2.2</b> Installation<span></span></a></li>
<li class="chapter" data-level="7.2.3" data-path="welfare-data.html"><a href="welfare-data.html#remote-server"><i class="fa fa-check"></i><b>7.2.3</b> Remote server<span></span></a></li>
<li class="chapter" data-level="7.2.4" data-path="welfare-data.html"><a href="welfare-data.html#usage"><i class="fa fa-check"></i><b>7.2.4</b> Usage<span></span></a></li>
<li class="chapter" data-level="7.2.5" data-path="welfare-data.html"><a href="welfare-data.html#preparing-survey-data-for-poverty-calculator-pipeline"><i class="fa fa-check"></i><b>7.2.5</b> Preparing survey data for Poverty Calculator Pipeline<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="welfare-data.html"><a href="welfare-data.html#survey-id"><i class="fa fa-check"></i><b>7.3</b> Survey ID nomenclature<span></span></a></li>
<li class="chapter" data-level="7.4" data-path="welfare-data.html"><a href="welfare-data.html#survey-id-cache"><i class="fa fa-check"></i><b>7.4</b> Survey CACHE ID nomenclature<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="auxiliary-data.html"><a href="auxiliary-data.html"><i class="fa fa-check"></i><b>8</b> Auxiliary data<span></span></a>
<ul>
<li class="chapter" data-level="8.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#population"><i class="fa fa-check"></i><b>8.1</b> Population<span></span></a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#original-data"><i class="fa fa-check"></i><b>8.1.1</b> Original data<span></span></a></li>
<li class="chapter" data-level="8.1.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#data-structure"><i class="fa fa-check"></i><b>8.1.2</b> Data structure<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#national-accounts"><i class="fa fa-check"></i><b>8.2</b> National Accounts<span></span></a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#gdp"><i class="fa fa-check"></i><b>8.2.1</b> GDP<span></span></a></li>
<li class="chapter" data-level="8.2.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#consumption-pce"><i class="fa fa-check"></i><b>8.2.2</b> Consumption (PCE)<span></span></a></li>
<li class="chapter" data-level="8.2.3" data-path="auxiliary-data.html"><a href="auxiliary-data.html#national-accounts-special-cases"><i class="fa fa-check"></i><b>8.2.3</b> National Accounts, Special Cases<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="auxiliary-data.html"><a href="auxiliary-data.html#cpi"><i class="fa fa-check"></i><b>8.3</b> CPI<span></span></a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#raw-data"><i class="fa fa-check"></i><b>8.3.1</b> Raw data<span></span></a></li>
<li class="chapter" data-level="8.3.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#vintage-control"><i class="fa fa-check"></i><b>8.3.2</b> Vintage control<span></span></a></li>
<li class="chapter" data-level="8.3.3" data-path="auxiliary-data.html"><a href="auxiliary-data.html#data-structure-1"><i class="fa fa-check"></i><b>8.3.3</b> Data structure<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="auxiliary-data.html"><a href="auxiliary-data.html#ppp"><i class="fa fa-check"></i><b>8.4</b> PPP<span></span></a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#raw-data-1"><i class="fa fa-check"></i><b>8.4.1</b> Raw data<span></span></a></li>
<li class="chapter" data-level="8.4.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#data-structure-2"><i class="fa fa-check"></i><b>8.4.2</b> Data structure<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="auxiliary-data.html"><a href="auxiliary-data.html#price-framework-pfw"><i class="fa fa-check"></i><b>8.5</b> Price FrameWork (PFW)<span></span></a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#original-data-1"><i class="fa fa-check"></i><b>8.5.1</b> Original data<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="auxiliary-data.html"><a href="auxiliary-data.html#abbreviations"><i class="fa fa-check"></i><b>8.6</b> Abbreviations<span></span></a></li>
</ul></li>
<li class="part"><span><b>III PIP Procedures<span></span></b></span></li>
<li class="chapter" data-level="9" data-path="pcpipeline.html"><a href="pcpipeline.html"><i class="fa fa-check"></i><b>9</b> Poverty Calculator Pipeline (pre-computed estimations)<span></span></a>
<ul>
<li class="chapter" data-level="9.1" data-path="pcpipeline.html"><a href="pcpipeline.html#folder-structure-1"><i class="fa fa-check"></i><b>9.1</b> Folder structure<span></span></a>
<ul>
<li><a href="pcpipeline.html#folders">Folders<span></span></a></li>
<li><a href="pcpipeline.html#files">Files<span></span></a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="pcpipeline.html"><a href="pcpipeline.html#prerequisites"><i class="fa fa-check"></i><b>9.2</b> Prerequisites<span></span></a></li>
<li class="chapter" data-level="9.3" data-path="pcpipeline.html"><a href="pcpipeline.html#structure-of-the-_targets.r-file"><i class="fa fa-check"></i><b>9.3</b> Structure of the <code>_targets.R</code> file<span></span></a>
<ul>
<li><a href="pcpipeline.html#start-up">Start up<span></span></a></li>
<li><a href="pcpipeline.html#step-1-small-functions">Step 1: small functions<span></span></a></li>
<li><a href="pcpipeline.html#step-2-preparing-the-data">Step 2: preparing the data<span></span></a></li>
<li><a href="pcpipeline.html#step-3-the-actual-pipeline">Step 3: The actual pipeline<span></span></a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="pcpipeline.html"><a href="pcpipeline.html#understanding-the-pipeline"><i class="fa fa-check"></i><b>9.4</b> Understanding the pipeline<span></span></a>
<ul>
<li><a href="pcpipeline.html#stem-targets">Stem targets<span></span></a></li>
<li><a href="pcpipeline.html#branches-targets">Branches targets<span></span></a></li>
<li><a href="pcpipeline.html#creating-the-cache-files">Creating the cache files<span></span></a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="pcpipeline.html"><a href="pcpipeline.html#understanding-pipdm-functions"><i class="fa fa-check"></i><b>9.5</b> Understanding <code>{pipdm}</code> functions<span></span></a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="pcpipeline.html"><a href="pcpipeline.html#internal-structure-of-pipdm-functions"><i class="fa fa-check"></i><b>9.5.1</b> Internal structure of <code>{pipdm}</code> functions<span></span></a></li>
<li class="chapter" data-level="9.5.2" data-path="pcpipeline.html"><a href="pcpipeline.html#updating-pipdm-or-any-other-pip-package"><i class="fa fa-check"></i><b>9.5.2</b> Updating <code>{pipdm}</code> (or any other PIP package)<span></span></a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="pcpipeline.html"><a href="pcpipeline.html#executing-the-_targets.r-file"><i class="fa fa-check"></i><b>9.6</b> Executing the <code>_targets.R</code> file<span></span></a></li>
<li class="chapter" data-level="9.7" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging"><i class="fa fa-check"></i><b>9.7</b> Debugging<span></span></a>
<ul>
<li><a href="pcpipeline.html#debugging-stem-targets">Debugging stem targets<span></span></a></li>
<li><a href="pcpipeline.html#debugging-branch-targets">Debugging branch targets<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="tmpipelilne.html"><a href="tmpipelilne.html"><i class="fa fa-check"></i><b>10</b> Table Maker Pipeline<span></span></a></li>
<li class="part"><span><b>IV Standalone Technical Considerations<span></span></b></span></li>
<li class="chapter" data-level="11" data-path="load.html"><a href="load.html"><i class="fa fa-check"></i><b>11</b> Load microdata and Auxiliary data<span></span></a>
<ul>
<li class="chapter" data-level="11.1" data-path="load.html"><a href="load.html#auxiilary-data"><i class="fa fa-check"></i><b>11.1</b> Auxiilary data<span></span></a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="load.html"><a href="load.html#udpate-data"><i class="fa fa-check"></i><b>11.1.1</b> udpate data<span></span></a></li>
<li class="chapter" data-level="11.1.2" data-path="load.html"><a href="load.html#load-data"><i class="fa fa-check"></i><b>11.1.2</b> Load data<span></span></a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="load.html"><a href="load.html#microdata-1"><i class="fa fa-check"></i><b>11.2</b> Microdata<span></span></a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="load.html"><a href="load.html#inventory-file"><i class="fa fa-check"></i><b>11.2.1</b> Inventory file<span></span></a></li>
<li class="chapter" data-level="11.2.2" data-path="load.html"><a href="load.html#finding-data"><i class="fa fa-check"></i><b>11.2.2</b> Finding data<span></span></a></li>
<li class="chapter" data-level="11.2.3" data-path="load.html"><a href="load.html#loading-data"><i class="fa fa-check"></i><b>11.2.3</b> Loading data<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="pc-docker.html"><a href="pc-docker.html"><i class="fa fa-check"></i><b>12</b> Docker Container<span></span></a>
<ul>
<li class="chapter" data-level="12.1" data-path="pc-docker.html"><a href="pc-docker.html#introduction"><i class="fa fa-check"></i><b>12.1</b> Introduction<span></span></a></li>
<li class="chapter" data-level="12.2" data-path="pcpipeline.html"><a href="pcpipeline.html#prerequisites"><i class="fa fa-check"></i><b>12.2</b> Prerequisites<span></span></a></li>
<li class="chapter" data-level="12.3" data-path="pc-docker.html"><a href="pc-docker.html#docker-on-world-bank-laptops"><i class="fa fa-check"></i><b>12.3</b> Docker on World Bank laptops<span></span></a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="pc-docker.html"><a href="pc-docker.html#wb-docker-install"><i class="fa fa-check"></i><b>12.3.1</b> Install Docker<span></span></a></li>
<li class="chapter" data-level="12.3.2" data-path="pc-docker.html"><a href="pc-docker.html#known-problems-and-solutions"><i class="fa fa-check"></i><b>12.3.2</b> Known problems and solutions<span></span></a></li>
<li class="chapter" data-level="12.3.3" data-path="pc-docker.html"><a href="pc-docker.html#tips-and-tricks"><i class="fa fa-check"></i><b>12.3.3</b> Tips and tricks<span></span></a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="pc-docker.html"><a href="pc-docker.html#create-volume"><i class="fa fa-check"></i><b>12.4</b> Create volume<span></span></a></li>
<li class="chapter" data-level="12.5" data-path="pc-docker.html"><a href="pc-docker.html#build-image"><i class="fa fa-check"></i><b>12.5</b> Build image<span></span></a></li>
<li class="chapter" data-level="12.6" data-path="pc-docker.html"><a href="pc-docker.html#run-container"><i class="fa fa-check"></i><b>12.6</b> Run container<span></span></a></li>
<li class="chapter" data-level="12.7" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging"><i class="fa fa-check"></i><b>12.7</b> Debugging<span></span></a></li>
<li class="chapter" data-level="12.8" data-path="pc-docker.html"><a href="pc-docker.html#security"><i class="fa fa-check"></i><b>12.8</b> Security<span></span></a></li>
<li class="chapter" data-level="12.9" data-path="pc-docker.html"><a href="pc-docker.html#base-image-options"><i class="fa fa-check"></i><b>12.9</b> Base image options<span></span></a></li>
<li class="chapter" data-level="12.10" data-path="pc-docker.html"><a href="pc-docker.html#using-r-on-linux"><i class="fa fa-check"></i><b>12.10</b> Using R on Linux<span></span></a></li>
<li class="chapter" data-level="12.11" data-path="pc-docker.html"><a href="pc-docker.html#resources"><i class="fa fa-check"></i><b>12.11</b> Resources<span></span></a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="azure.html"><a href="azure.html"><i class="fa fa-check"></i><b>13</b> Deploying to Azure<span></span></a>
<ul>
<li class="chapter" data-level="13.1" data-path="azure.html"><a href="azure.html#azure-pc-data"><i class="fa fa-check"></i><b>13.1</b> Poverty Calculator Data<span></span></a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="azure.html"><a href="azure.html#deploying-data-on-dev"><i class="fa fa-check"></i><b>13.1.1</b> Deploying data on DEV<span></span></a></li>
<li class="chapter" data-level="13.1.2" data-path="azure.html"><a href="azure.html#deploying-data-on-qa"><i class="fa fa-check"></i><b>13.1.2</b> Deploying data on QA<span></span></a></li>
<li class="chapter" data-level="13.1.3" data-path="azure.html"><a href="azure.html#deploying-data-to-production"><i class="fa fa-check"></i><b>13.1.3</b> Deploying data to Production<span></span></a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="azure.html"><a href="azure.html#azure-pc-docker"><i class="fa fa-check"></i><b>13.2</b> Poverty Calculator Docker image<span></span></a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="azure.html"><a href="azure.html#deploying-image-on-dev"><i class="fa fa-check"></i><b>13.2.1</b> Deploying image on DEV<span></span></a></li>
<li class="chapter" data-level="13.2.2" data-path="azure.html"><a href="azure.html#deploying-image-on-qa"><i class="fa fa-check"></i><b>13.2.2</b> Deploying image on QA<span></span></a></li>
<li class="chapter" data-level="13.2.3" data-path="azure.html"><a href="azure.html#deploying-image-to-production"><i class="fa fa-check"></i><b>13.2.3</b> Deploying image to Production<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="gh-workflows.html"><a href="gh-workflows.html"><i class="fa fa-check"></i><b>14</b> Github Workflows<span></span></a>
<ul>
<li class="chapter" data-level="14.1" data-path="gh-workflows.html"><a href="gh-workflows.html#package-webpage-using-pkgdown"><i class="fa fa-check"></i><b>14.1</b> Package webpage using <code>{pkgdown}</code><span></span></a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="gh-workflows.html"><a href="gh-workflows.html#create-gh-pages-branch"><i class="fa fa-check"></i><b>14.1.1</b> Create <code>gh-pages</code> branch<span></span></a></li>
<li class="chapter" data-level="14.1.2" data-path="gh-workflows.html"><a href="gh-workflows.html#create-setup-files"><i class="fa fa-check"></i><b>14.1.2</b> Create “setup” files<span></span></a></li>
<li class="chapter" data-level="14.1.3" data-path="gh-workflows.html"><a href="gh-workflows.html#activate-github-pages"><i class="fa fa-check"></i><b>14.1.3</b> Activate Github Pages<span></span></a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="gh-workflows.html"><a href="gh-workflows.html#package-build-checks"><i class="fa fa-check"></i><b>14.2</b> Package build checks<span></span></a></li>
<li class="chapter" data-level="14.3" data-path="gh-workflows.html"><a href="gh-workflows.html#code-coverage"><i class="fa fa-check"></i><b>14.3</b> Code coverage<span></span></a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="gh-workflows.html"><a href="gh-workflows.html#create-setup-files-1"><i class="fa fa-check"></i><b>14.3.1</b> Create “setup” files<span></span></a></li>
<li class="chapter" data-level="14.3.2" data-path="gh-workflows.html"><a href="gh-workflows.html#integrate-with-codecov.io"><i class="fa fa-check"></i><b>14.3.2</b> Integrate with codecov.io<span></span></a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="gh-workflows.html"><a href="gh-workflows.html#other-workflows"><i class="fa fa-check"></i><b>14.4</b> Other workflows<span></span></a></li>
</ul></li>
<li><a href="references.html#references">References<span></span></a></li>
<li class="divider"></li>
<li><a href="https://github.com/PIP-Technical-Team/PIPmanual" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">PIP Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div class="rmdbox rmdwarning"><strong>DISCLAIMER:</strong> This book contains relevant only for the internal Technical team of the PIP project. It has been made available to the public for the sake of transparency, but its information has no use outside the internal team.
 </div>
<div id="pc-docker" class="section level1 hasAnchor" number="12">
<h1><span class="header-section-number">Chapter 12</span> Docker Container<a href="pc-docker.html#pc-docker" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction" class="section level2 hasAnchor" number="12.1">
<h2><span class="header-section-number">12.1</span> Introduction<a href="pc-docker.html#introduction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This chapter explains how to develop and run the Docker container for the Poverty
Calculator API on local World Bank laptops. For DEV, QA and Production
deployments please see the chapter on <a href="azure.html#azure">Deploying to Azure</a>.
For the Table Maker API please refer to <span style="color:red">TBD</span>.</p>
</div>
<div id="prerequisites" class="section level2 hasAnchor" number="12.2">
<h2><span class="header-section-number">12.2</span> Prerequisites<a href="pcpipeline.html#prerequisites" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Local admin account</li>
<li>Docker Desktop for Windows</li>
<li>WSL 2 (recommended)</li>
<li>Visual Studio Code (recommended)</li>
</ul>
<p>See below for recommendations on how to
install Docker Desktop and WSL 2.</p>
<p>Visual Code is not strictly needed, but the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker">VS Docker
plugin</a>
is one of the best tools to interact with Docker.</p>
</div>
<div id="docker-on-world-bank-laptops" class="section level2 hasAnchor" number="12.3">
<h2><span class="header-section-number">12.3</span> Docker on World Bank laptops<a href="pc-docker.html#docker-on-world-bank-laptops" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="wb-docker-install" class="section level3 hasAnchor" number="12.3.1">
<h3><span class="header-section-number">12.3.1</span> Install Docker<a href="pc-docker.html#wb-docker-install" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Install <a href="https://docs.docker.com/docker-for-windows/release-notes/">Docker Dekstop</a> (v. 3.6.0 or later)
<ul>
<li>Remember to check the box to enable WSL integration.</li>
</ul></li>
<li>Activate WSL
<ul>
<li>Check if the WSL feature on Windows is activated (e.g. run <code>wsl --help</code> from Powershell). If it is then proceed to step 3.
Note: If you get a message saying “service cannot be started” try restarting WSL like suggested below under <a href="pc-docker.html#known-problems-and-solutions">Known problems and solutions</a>.</li>
<li>Go to Control Panel -&gt; Programs -&gt; Turn Windows features on or off and check the box <em>Windows Subsystem for Linux</em>, or follow <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">these steps</a> if you prefer to activate WSL from the command line.</li>
<li>Reboot system.</li>
</ul></li>
<li>Install WSL 2
<ul>
<li>Download and install the <a href="https://docs.microsoft.com/windows/wsl/wsl2-kernel">Linux kernel update package</a>.</li>
<li>Set WSL 2 as your default version (run <code>wsl --set-default-version 2</code> from Powershell).</li>
</ul></li>
<li>Configure Docker access privileges
<ul>
<li>In order to run Docker wo/ admin privileges you need to add yourself to the “docker-users” group.</li>
<li>Open Computer Management. Go to Local User and Groups -&gt; Groups -&gt; docker-users and add your regular account (<code>WB/wb&lt;UPI&gt;</code>) to the list of users.</li>
<li>Reboot system.</li>
</ul></li>
<li>Start Docker Desktop and enjoy your hard work :-)</li>
</ol>
</div>
<div id="known-problems-and-solutions" class="section level3 hasAnchor" number="12.3.2">
<h3><span class="header-section-number">12.3.2</span> Known problems and solutions<a href="pc-docker.html#known-problems-and-solutions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Docker Dekstop sometimes fails with the following error.</p>
<pre><code>System.InvalidOperationException:
Failed to deploy distro docker-desktop to C:\Users\&lt;User&gt;\AppData\Local\Docker\wsl\distro: exit code: -1
stdout: Error: 0xffffffff</code></pre>
<p>The root cause of this problem is likely that the World Bank VPN connection modifies
the same network configuration as the <code>wsl</code> VM. Turning off your VPN when working with
Docker locally is thus a good idea.</p>
<p>A temporary solution to the issue is to open a CMD shell in Admin
mode, and then run the following code to restart <code>LxssManager</code> .</p>
<pre class="cmd"><code>&gt; sc config LxssManager start=auto
[SC] ChangeServiceConfig SUCCESS</code></pre>
<p>After this you will also need to restart Docker Desktop.</p>
</div>
<div id="tips-and-tricks" class="section level3 hasAnchor" number="12.3.3">
<h3><span class="header-section-number">12.3.3</span> Tips and tricks<a href="pc-docker.html#tips-and-tricks" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Start your Docker working day by opening a CMD shell in admin-mode and run
<code>sc config LxssManager start=auto</code>. Keep the shell open because you might
need to re-run the command if WSL crashes.</li>
<li>Turn off your VPN when using Docker. This avoids the issue with WSL crashing
from time to time. It still might happen though if the VPN switces on
automatically or if you for other reasons switch back and forth.</li>
<li>It is possible that solutions like <a href="https://github.com/sakai135/wsl-vpnkit">wsl-vpnkit</a>
and <a href="https://github.com/moby/vpnkit">vpnkit</a> will help with the WSL issues,
but these have not been tested yet. Feel free to give it a try yourself.</li>
<li>If WSL causes too much pain, try switching to the legacy Hyper-V backend.
(Go to Docker Desktop -&gt; General Setting -&gt; Use the WSL 2 based engine).</li>
<li>Re-build an image from a partial cache by adding a <code>ARG</code> or <code>ENV</code> variable
right before the layer you want to invalidate (yes, this is hacky but it
works). E.g. do something like:</li>
</ol>
<div class="sourceCode" id="cb58"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb58-1"><a href="pc-docker.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install PIP specific R packages </span></span>
<span id="cb58-2"><a href="pc-docker.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> test=test06302021</span>
<span id="cb58-3"><a href="pc-docker.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_github(&#39;PIP-Technical-Team/wbpip@master&#39;, repos = &#39;</span><span class="va">${CRAN}</span><span class="st">&#39;)&quot;</span></span>
<span id="cb58-4"><a href="pc-docker.html#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_github(&#39;PIP-Technical-Team/pipapi@master&#39;, repos = &#39;</span><span class="va">${CRAN}</span><span class="st">&#39;)&quot;</span></span></code></pre></div>
</div>
</div>
<div id="create-volume" class="section level2 hasAnchor" number="12.4">
<h2><span class="header-section-number">12.4</span> Create volume<a href="pc-docker.html#create-volume" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The data that is used in the poverty calculations is stored outside the Docker
container. We therefore need to link a data source on our local machine to the
container when we run it. This could be accomplished with a <a href="https://docs.docker.com/storage/bind-mounts/">bind
mount</a>, but the preferred way is
to use a <a href="https://docs.docker.com/storage/volumes/">named volume</a>.</p>
<p>You can create and populate a volume by following the steps below. First we
create an empty volume, then we link this to a temporay container, before using
<code>docker cp</code> to copy the files to the container and volume. After the data has
been copied you can discard the temporary container. The choice of Ubuntu 20.04
for the <em>temporary</em> container is arbitrary. You could use another image if you want.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="pc-docker.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create volume </span></span>
<span id="cb59-2"><a href="pc-docker.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> volume create pip-vol</span>
<span id="cb59-3"><a href="pc-docker.html#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mount volume to tmp container  </span></span>
<span id="cb59-4"><a href="pc-docker.html#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">--name</span> pip-data <span class="at">--mount</span> type=volume,source=pip-vol,target=/data ubuntu:20.04</span>
<span id="cb59-5"><a href="pc-docker.html#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy data to container (and volume)</span></span>
<span id="cb59-6"><a href="pc-docker.html#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> cp <span class="op">&lt;</span>data-folder<span class="op">&gt;</span>/. pip-data:data</span>
<span id="cb59-7"><a href="pc-docker.html#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop and remove tmp container </span></span>
<span id="cb59-8"><a href="pc-docker.html#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> stop pip-data </span>
<span id="cb59-9"><a href="pc-docker.html#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> rm pip-data</span></code></pre></div>
<p>For some purposes you will only need to create this volume once, but remember to
update the contents of the volume in case the data structure changes or you want
to make sure the container is running against the latest available data. See the
<a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">Azure DevOps Data repo</a>
(DEV branch) for the latest updates.</p>
<p>The volume can be inspected with the <code>docker inspect</code> and <code>docker system</code>
commands. If you are running Docker Desktop on Windows with WSL 2.0 then then
the physical location of Docker volumes is usually found under
<code>\\wsl$\docker-desktop-data\version-pack-data\community\docker\volumes</code>. For
more information on volumes see the <a href="https://docs.docker.com/storage/volumes/">Use
volumes</a> section in Docker’s reference
manual.</p>
</div>
<div id="build-image" class="section level2 hasAnchor" number="12.5">
<h2><span class="header-section-number">12.5</span> Build image<a href="pc-docker.html#build-image" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Docker images are built using the <code>docker build</code> command. Here we build the
image and set the image name to <code>pip-api</code>.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb60-1"><a href="pc-docker.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> pip-api .</span></code></pre></div>
<p>You can also set a specific tag for the image. For example you can specify the
version number or the base image used as source. How you decide to tag your
images is up to you. Often a tag of <code>latest</code> (the default) will suffice, but in
other instances keeping track of different versions of your development image
will be useful.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb61-1"><a href="pc-docker.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set tag when building</span></span>
<span id="cb61-2"><a href="pc-docker.html#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> pip-api:0.0.4</span>
<span id="cb61-3"><a href="pc-docker.html#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set tag after build (version number) </span></span>
<span id="cb61-4"><a href="pc-docker.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> image tag pip-api:latest pip-api:0.0.4</span>
<span id="cb61-5"><a href="pc-docker.html#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set tag after build (base image)</span></span>
<span id="cb61-6"><a href="pc-docker.html#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> image tag pip-api:latest pip-api:ubi8 </span></code></pre></div>
<p>Note that each layer in a Dockerfile is cached when built. These layers won’t be
re-run unless the code to produce that specific layer or a previous layer in the
Dockerfile changes. This is handy for fast iterations, but can also cause the
image to be outdated.</p>
<p>If needed you can use the <code>--no-cache</code> flag to force a re-build. This is useful
when you want to make sure that the latest Linux updates are installed or for
updating the <code>{wbpip}</code> and <code>{pipapi}</code> R packages. See also the <a href="pc-docker.html#tips-and-tricks">Tips and
Tricks</a> section on how to do partial re-builds.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="pc-docker.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">--no-cache</span> <span class="at">-t</span> pip-api .</span></code></pre></div>
</div>
<div id="run-container" class="section level2 hasAnchor" number="12.6">
<h2><span class="header-section-number">12.6</span> Run container<a href="pc-docker.html#run-container" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Run the container by exposing port 80 and mounting a volume with the survey and
auxiliary data. The data structure in the attached volume must correspond to the
sub-folder specifications in <code>R/main.R</code>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="pc-docker.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-d</span> <span class="at">-p</span> 80:80/tcp <span class="at">--mount</span> src=pip-vol,target=/ipp,type=volume,readonly <span class="at">--name</span> pip-api pip-api</span></code></pre></div>
<p>You can also run the container with a bind mount if you prefer, but note that reading the files inside mount folder
will be slower then with a volumne setup.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="pc-docker.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-d</span> <span class="at">-p</span> 80:80/tcp <span class="at">--mount</span> src=<span class="st">&quot;&lt;data-folder&gt;&quot;</span>,target=/data,type=bind <span class="at">--name</span> pip-api pip-api</span></code></pre></div>
<p>Navigate to <a href="localhost/__docs__/"><code>http://localhost/__docs__/</code></a> to see the
running API.</p>
<p>For details on the <code>docker run</code> command and its options see the <a href="https://docs.docker.com/engine/reference/commandline/run/">Docker
Docs</a>.</p>
</div>
<div id="debugging" class="section level2 hasAnchor" number="12.7">
<h2><span class="header-section-number">12.7</span> Debugging<a href="pcpipeline.html#debugging" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Run container interactively:</strong></p>
<p>Run the container in interactive mode, using the <code>-it</code> flag, to see output
messages.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="pc-docker.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker run <span class="at">--rm</span> <span class="at">-it</span> <span class="at">-p</span> 80:80/tcp <span class="at">--mount</span> src=pip-vol,target=/ipp,type=volume,readonly <span class="at">--name</span> pip-api pip-api</span>
<span id="cb65-2"><a href="pc-docker.html#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Running</span> plumber API at http://0.0.0.0:80</span>
<span id="cb65-3"><a href="pc-docker.html#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Running</span> swagger Docs at http://127.0.0.1:80/__docs__/</span></code></pre></div>
<p><strong>Inspect container:</strong></p>
<p>For development purposes it can be useful to inspect the Docker container.
Luckily it is very easy to enter a running container with the <code>docker exec</code>
command.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="pc-docker.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Enter the container as default user </span></span>
<span id="cb66-2"><a href="pc-docker.html#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker exec <span class="at">-it</span> pip-api /bin/bash</span>
<span id="cb66-3"><a href="pc-docker.html#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="ex">plumber@bd8ea77299ca:/$</span> </span>
<span id="cb66-4"><a href="pc-docker.html#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Enter the container as root user</span></span>
<span id="cb66-5"><a href="pc-docker.html#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker exec <span class="at">-it</span> <span class="at">-u</span> 0 pip-api /bin/bash</span>
<span id="cb66-6"><a href="pc-docker.html#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="ex">root@bd8ea77299ca:/$</span> </span></code></pre></div>
</div>
<div id="security" class="section level2 hasAnchor" number="12.8">
<h2><span class="header-section-number">12.8</span> Security<a href="pc-docker.html#security" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Since the PIP Techincal Team is developing both the API and the Docker
container, we also have a larger responsibility for security. When deploying to
Azure the image will need to go through a security scan, provided by
<a href="https://blog.aquasec.com/">Aquasec</a>, that is generally quite strict. Any high
level vulnerability found by the Aquasec scan will result in a failed
deployment. It is not possible to leverage Aquasec on local machines, but we can
get an indication of potential vulnerabilites by taking advantage of the built
in security scan that comes with Docker. Additionally it is also possible to
scan the contents of the R packages used in the image.</p>
<p>Note that neither the Snyk or Oyster scans described below are requirements from
OIS. They are only included here as additional and preliminary tools.</p>
<p><strong>Run image security scan:</strong></p>
<p>Before deploying to Azure you can run preliminary security scans with Snyk. See
<a href="https://docs.docker.com/engine/scan/">Vulnerability scanning for Docker local
images</a> and <a href="https://snyk.io/learn/docker-security-scanning/">Docker Security Scanning
Guide 2021</a> for details.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb67-1"><a href="pc-docker.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> scan <span class="at">--file</span> .<span class="dt">\D</span>ockerfile pip-api</span></code></pre></div>
<p>It is important to note that the Aquasec scan that runs on Azure is different
that the Snyk scan, and can detect different vulnerabilites. Even though few or
zero vulnerabilites are found by Snyk, further issues might still be detected by
Aquasec.</p>
<p><strong>Run security scan for R packages:</strong></p>
<p>You can scan the R packages inside the container with the <code>{oysteR}</code> package,
which scans R projects against insecure dependencies using the <a href="https://ossindex.sonatype.org/">OSS
Index</a>.</p>
<p>First log into a running container as root, and start R.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="pc-docker.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker exec <span class="at">-it</span> <span class="at">-u</span> 0 pip-api /bin/bash</span>
<span id="cb68-2"><a href="pc-docker.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="ex">root@ab54fbf1eb36:/#</span> R </span></code></pre></div>
<p>Then install the <code>{oyster}</code> package, and run an audit.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="pc-docker.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;oysteR&quot;</span>)</span>
<span id="cb69-2"><a href="pc-docker.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;oysteR&quot;</span>)</span>
<span id="cb69-3"><a href="pc-docker.html#cb69-3" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> <span class="fu">audit_installed_r_pkgs</span>()</span>
<span id="cb69-4"><a href="pc-docker.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="fu">get_vulnerabilities</span>(audit)</span></code></pre></div>
<p>Note that finding zero vulnerabilities is no guarantee against threats. For
example is scanning of C++ code inside R packages not yet implemented. For more
details and latest developments on the <code>{oyster}</code> package see the
<a href="https://github.com/sonatype-nexus-community/oysteR">README</a> on Github.</p>
</div>
<div id="base-image-options" class="section level2 hasAnchor" number="12.9">
<h2><span class="header-section-number">12.9</span> Base image options<a href="pc-docker.html#base-image-options" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the development process of the Dockerfile there have been used different base
images.</p>
<p>The current image in the main branch is based on <code>ubi8</code>, but other options
(<code>rocker</code>, <code>centos8</code>) are available in seperate branches. These seperate
branches will not be actively maintained, but should be kept in case there is a
need to switch to another base image in the future.</p>
<p>The main need to switch base image is likely to stem from the Azure DevOps
security scan. For example do images based on <code>rocker</code> or <code>centos8</code> work well
locally, but neither will pass deployment. CentOS images are unfortunately not
on the list of approved images by OIS, while
<a href="https://github.com/rocker-org/rocker-versioned2/">Rocker</a> images (which are
based on Ubuntu 20.04 LTS) currently has a vulnerability
(<a href="https://ubuntu.com/security/CVE-2019-18276">CVE-2019-18276</a>) that is
classified as a high level threat by Aqua Scan.</p>
<p>In fact one of the Linux dependencies for R on UBI 8, <code>libX11</code>, also currently
trigger a high level vulnerability
(<a href="https://access.redhat.com/security/cve/CVE-2020-14363">CVE-2020-14363</a>) in
Aqua Scan. Even though this issue has been solved in the offical RHEL 8 release,
the issue still persist for UBI 8. It can however be solved by manually
downloading a newer version of libX11 (1.6.12 or later), and removing the
problematic version (1.6.8).</p>
<p>In case there is any need to develop with other base images in the future it is
<strong>strongly recommended</strong> to start with one of the Linux distributions where
<a href="https://docs.rstudio.com/resources/install-r/">RStudio provides precompiled binaries for
R</a>. This avoids the need to
install R from source.</p>
</div>
<div id="using-r-on-linux" class="section level2 hasAnchor" number="12.10">
<h2><span class="header-section-number">12.10</span> Using R on Linux<a href="pc-docker.html#using-r-on-linux" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Docker images are usually based on Linux containers. Some familiarity with Linux is
thus necessary in order to develop and work with Docker.</p>
<p>R users in particular should familiarize themselves with the difference between installing R
and R packages from source vs binary, as well as potential Linux dependencies that might
be nessecary to make a specific package work.</p>
<p><strong>Installing R:</strong></p>
<p><a href="https://docs.rstudio.com/resources/install-r-source/">Installing R from source</a> is possible
on most Linux distributions, but this not always an easy endavour. It will often require you to
maintain a list of the nessecary Linux dependencies for R. Installing from source is also much
slower than installing from a binary version.</p>
<p>Another way to install R on Linux is to use the available pre-compiled binary in your
Linux distro’s repository (e.g <code>sudo apt install r-base</code> on Ubuntu). The problem with
this approach is that the latest version of R might not yet be available, and for some
Linux distro’s there will also only be a limited number of R versions available.
This impedes the flexilibility needed for a production grade project.</p>
<p>The recommended approach is thus to rely on
<a href="https://docs.rstudio.com/resources/install-r/">RStudio’s precompiled binaries</a>.
These binaries are available for the most common Linux distributions,
including Ubuntu, Debian and CentOS / RHEL.
Relying on these binaries will limited the number of base image options avaiable,
e.g. a ligth-weight distro like <a href="https://www.alpinelinux.org/">Alpine</a> is not supported,
nor is the newest release of Ubuntu (Hirsute Hippo). But it will make much easier
to maintain, upgrade and change the R version used in the project.</p>
<p><strong>Installing R packages:</strong></p>
<p>As a contrast to Windows and macOS, CRAN only supports source versions of the R packages
available for Linux.
This will significantly slow down the installation process of each pacakge.</p>
<p>Luckily RStudio provides binary versions of all packages on CRAN for a series of different Linux distro’s through their
<a href="https://packagemanager.rstudio.com/">Public Pacakge Manager</a>. It is therefore strongly recommended
that you rely on RSPM as your installation repo.</p>
<p>An additional benefit of RSPM is that you can also select a specific date for the package versions
to use.</p>
<p>On the RSPM website go the <a href="https://packagemanager.rstudio.com/client/#/repos/1/overview">Setup</a>
page on the main menu and select the appropiate client OS and date. You should then see a URL similar too
<code>https://packagemanager.rstudio.com/all/__linux__/centos8/4743918</code>, where <code>centos8</code> represents the distro
and <code>4743918</code> the date.</p>
<p>For a more detailed introduction to the difference between binary and source packages, see
<a href="https://r-pkgs.org/package-structure-state.html">Package structure and state</a> in the book
R Packages.</p>
<p><strong>Installing R package dependencies:</strong></p>
<p>Linux distro’s doesn’t come with the dependencies needed to work with all R packages. This includes common
packages like <code>{data.table}</code> and <code>{plumber}</code>. It is important that such dependencies are installed prior
to the installation of your R packages.</p>
<p>The best way to look for dependencies is to use the RSPM website and search for the specific package in question.
Remeber to also select the correct Linux distribution.</p>
</div>
<div id="resources" class="section level2 hasAnchor" number="12.11">
<h2><span class="header-section-number">12.11</span> Resources<a href="pc-docker.html#resources" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For a further introduction to Docker take a look at this
<a href="https://raw.githack.com/uo-ec607/lectures/master/13-docker/13-docker.html#1">Data Science for Economists lecture on Docker</a>
by Grant McDermott.</p>
<p>See <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Best practices for writing
Dockerfiles</a>
for advice on how to build Docker images.</p>
<p>Follow the <a href="https://docs.docker.com/docker-for-windows/release-notes/">Docker for Windows release
notes</a> for
information on new releases and bug fixes.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="load.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="azure.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/PIP-Technical-Team/PIPmanual/edit/master/docker.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["PIPmanual.pdf", "PIPmanual.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
