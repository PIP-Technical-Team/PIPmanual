<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>PIP Manual - 13&nbsp; Deploying to Azure</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./workflows.html" rel="next">
<link href="./docker.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./load_md_aux.html">Standalone Technical Considerations</a></li><li class="breadcrumb-item"><a href="./azure.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Deploying to Azure</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">PIP Manual</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./internal_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Internal Workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Folder_structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Folder Structure</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./joining_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Joining Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">PIP data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./price_framework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Price FrameWork (pfw) data frame</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PRIMUS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">PRIMUS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./welfare_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Welfare data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./auxiliary_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Auxiliary data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">PIP Procedures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pc_pipeline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Poverty Calculator Pipeline (pre-computed estimations)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tm_pipeline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Table Maker Pipeline</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Standalone Technical Considerations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./load_md_aux.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Load microdata and Auxiliary data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Docker Container</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./azure.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Deploying to Azure</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Github Workflows</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./subtrees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Subtrees using Smartgit</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#azure-pc-data" id="toc-azure-pc-data" class="nav-link active" data-scroll-target="#azure-pc-data"><span class="header-section-number">13.1</span> Poverty Calculator Data</a>
  <ul class="collapse">
  <li><a href="#deploying-data-on-dev" id="toc-deploying-data-on-dev" class="nav-link" data-scroll-target="#deploying-data-on-dev"><span class="header-section-number">13.1.1</span> Deploying data on DEV</a></li>
  <li><a href="#deploying-data-on-qa" id="toc-deploying-data-on-qa" class="nav-link" data-scroll-target="#deploying-data-on-qa"><span class="header-section-number">13.1.2</span> Deploying data on QA</a></li>
  <li><a href="#deploying-data-to-production" id="toc-deploying-data-to-production" class="nav-link" data-scroll-target="#deploying-data-to-production"><span class="header-section-number">13.1.3</span> Deploying data to Production</a></li>
  </ul></li>
  <li><a href="#azure-pc-docker" id="toc-azure-pc-docker" class="nav-link" data-scroll-target="#azure-pc-docker"><span class="header-section-number">13.2</span> Poverty Calculator Docker image</a>
  <ul class="collapse">
  <li><a href="#deploying-image-on-dev" id="toc-deploying-image-on-dev" class="nav-link" data-scroll-target="#deploying-image-on-dev"><span class="header-section-number">13.2.1</span> Deploying image on DEV</a></li>
  <li><a href="#deploying-image-on-qa" id="toc-deploying-image-on-qa" class="nav-link" data-scroll-target="#deploying-image-on-qa"><span class="header-section-number">13.2.2</span> Deploying image on QA</a></li>
  <li><a href="#deploying-image-to-production" id="toc-deploying-image-to-production" class="nav-link" data-scroll-target="#deploying-image-to-production"><span class="header-section-number">13.2.3</span> Deploying image to Production</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="azure" class="quarto-section-identifier"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Deploying to Azure</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>The Azure DevOps site for PIP currently consists of two repos:</p>
<ul>
<li><p>ITSES-POVERTYSCORE (docker file repo)</p></li>
<li><p>ITSES-POVERTYSCORE-DATA (data repo)</p></li>
</ul>
<p>Each repo consists of three branches:</p>
<ul>
<li><p>DEV</p></li>
<li><p>QA</p></li>
<li><p>PROD</p></li>
</ul>
<p>The PIP Technical Team will handle deployments to DEV and QA, while ITS needs to approve deployments to Production.</p>
<section id="azure-pc-data" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="azure-pc-data"><span class="header-section-number">13.1</span> Poverty Calculator Data</h2>
<p><span style="color:red">Note: The Azure Data repo has now been directly synced with pipeline outputs folder on the PIP network drive. There is thus no longer any need to push changes from your local computer.</span></p>
<section id="deploying-data-on-dev" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="deploying-data-on-dev"><span class="header-section-number">13.1.1</span> Deploying data on DEV</h3>
<p>Deploying the data to DEV consists of four main stages:</p>
<ul>
<li><p>Sync local data to remote Git repository on TFS</p></li>
<li><p>Run the Continuous Integration pipeline (CI)</p></li>
<li><p>Run the Continuous Deployment pipeline (CD) to move the data to Azure blob storage</p></li>
<li><p>Data is moved to the Virtual Machine (VM) running the API This stage is completed automatically every 30 minutes (as of 11/02/2021)</p></li>
</ul>
<p>You can deploy data to DEV by following the steps below:</p>
<section id="sync-data-to-remote-repo-on-tfs" class="level4" data-number="13.1.1.1">
<h4 data-number="13.1.1.1" class="anchored" data-anchor-id="sync-data-to-remote-repo-on-tfs"><span class="header-section-number">13.1.1.1</span> Sync data to remote repo on TFS</h4>
<p><strong>Step 1:</strong> Sync you local DEV branch with the remote.</p>
<p><strong>Step 2:</strong> Commit and push any data changes to the remote.</p>
</section>
<section id="run-ci-pipeline" class="level4" data-number="13.1.1.2">
<h4 data-number="13.1.1.2" class="anchored" data-anchor-id="run-ci-pipeline"><span class="header-section-number">13.1.1.2</span> Run CI pipeline</h4>
<p><strong>Step 3:</strong> Nagivate to the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">Azure DevOps Data repo</a>. Click on Pipelines.</p>
<p><img src="img/azure_pc_data_pipeline_step2.png" class="img-fluid"></p>
<p><strong>Step 4:</strong> Select the FILE-COPY-DEV-CI pipeline.</p>
<p><img src="img/azure_pc_data_pipeline_step3.png" class="img-fluid"></p>
<p><strong>Step 5:</strong> Click on Run pipeline.</p>
<p><img src="img/azure_pc_data_pipeline_step4.png" class="img-fluid"></p>
<p><strong>Step 6:</strong> Click on Variables -&gt; FolderName, and add the name of the folder which should be copied to the Cloud Blob Store.</p>
<p><span style="color:red">Note: This step is likely to change when the Data pipeline is re-written to handle mulitiple data version folders.</span></p>
<p><img src="img/azure_pc_data_pipeline_step5-1.png" class="img-fluid"></p>
<p><img src="img/azure_pc_data_pipeline_step5-2.png" class="img-fluid"></p>
<p><img src="img/azure_pc_data_pipeline_step5-3.png" class="img-fluid"></p>
<p><strong>Step 7:</strong> Click on Run.</p>
<p><img src="img/azure_pc_data_pipeline_step6.png" class="img-fluid"></p>
<p><strong>Step 8:</strong> View the new build.</p>
<p><img src="img/azure_pc_data_pipeline_step7.png" class="img-fluid"></p>
</section>
<section id="run-cd-pipeline" class="level4" data-number="13.1.1.3">
<h4 data-number="13.1.1.3" class="anchored" data-anchor-id="run-cd-pipeline"><span class="header-section-number">13.1.1.3</span> Run CD pipeline</h4>
<p><strong>Step 9:</strong> Click on Releases and select the FILE-COPY-DEV-CD release. Approve the pending request.</p>
<p><img src="img/azure_pc_data_pipeline_step8-1.png" class="img-fluid"></p>
<p><img src="img/azure_pc_data_pipeline_step8-2.png" class="img-fluid"></p>
<p><img src="img/azure_pc_data_pipeline_step8-3.png" class="img-fluid"></p>
<p><strong>Step 10:</strong> Verify that the build completed.</p>
<p><img src="img/azure_pc_data_pipeline_step9.png" class="img-fluid"></p>
</section>
<section id="move-data-to-vm" class="level4" data-number="13.1.1.4">
<h4 data-number="13.1.1.4" class="anchored" data-anchor-id="move-data-to-vm"><span class="header-section-number">13.1.1.4</span> Move data to VM</h4>
<p><strong>Step 11:</strong> Wait for the data on the VM to be updated. There is an automatic cron job that runs behind the scenes to copy the data from the blob storage to the VM. This runs at regular intervals, every 30 (?) minutes. You can use the <code>/data-timestamp</code> endpoint to verify that the transfer has completed. For additional information you can also use the <code>/dir-info</code> endpoint.</p>
</section>
<section id="restart-the-docker-container" class="level4" data-number="13.1.1.5">
<h4 data-number="13.1.1.5" class="anchored" data-anchor-id="restart-the-docker-container"><span class="header-section-number">13.1.1.5</span> Restart the Docker container</h4>
<p><strong>Step 12:</strong> Restart the Docker container by running the <code>RESTARTCONTAINER-DEV-CD</code> release pipeline.</p>
</section>
<section id="clear-the-vm-cache" class="level4" data-number="13.1.1.6">
<h4 data-number="13.1.1.6" class="anchored" data-anchor-id="clear-the-vm-cache"><span class="header-section-number">13.1.1.6</span> Clear the VM cache</h4>
<p><strong>Step 13:</strong> If you conducted a data update that includes changes to survey data or the estimation tables for an already existing version folder you will need to clear the cache on the VM. Use the specific API endpoints for cache handling to do this. <span style="color:red">Note: If in doubt always clear the cache.</span></p>
</section>
</section>
<section id="deploying-data-on-qa" class="level3" data-number="13.1.2">
<h3 data-number="13.1.2" class="anchored" data-anchor-id="deploying-data-on-qa"><span class="header-section-number">13.1.2</span> Deploying data on QA</h3>
<p><strong>Step 1:</strong> Nagivate to the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">Azure DevOps Data repo</a>.</p>
<p><strong>Step 2:</strong> Click on Create pull request. Select from DEV to QA.</p>
<p><strong>Step 3:</strong> Go through the steps to commit and approve the pull request. Please make sure that the <strong>“Delete source branch” box is NOT checked</strong>, ie. don’t delete the DEV branch. (This default should be modified going forward)</p>
<p><strong>Step 5:</strong> Go to Pipelines -&gt; Pipelines and select the FILE-COPY-QA-CI pipeline. Verify that the pipeline is building. If it wasn’t triggered you will need to trigger it manually.</p>
<p><strong>Step 6:</strong> Go to Pipelines -&gt; Releases and select the FILE-COPY-QA-CD release. Approve the request, and verify that the build completes.</p>
<p><strong>Step 7:</strong> Run the <code>RESTARTCONTAINER-QA-CD</code> release pipeline after the data transfer to the VMs has completed.</p>
<p><strong>Step 8:</strong> Clear the cache on the VMs if needed. <span style="color:red">Note: If in doubt always clear the cache.</span></p>
</section>
<section id="deploying-data-to-production" class="level3" data-number="13.1.3">
<h3 data-number="13.1.3" class="anchored" data-anchor-id="deploying-data-to-production"><span class="header-section-number">13.1.3</span> Deploying data to Production</h3>
<p><strong>Step 1:</strong> Nagivate to the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">Azure DevOps Data repo</a>.</p>
<p><strong>Step 2:</strong> Click on Create pull request. Select from QA to PROD.</p>
<p><strong>Step 3:</strong> Go through the steps to commit and approve the pull request. Please make sure that the “Delete source branch” box is unchecked, ie. don’t delete the QA branch.</p>
<p><strong>Step 5:</strong> Go to Pipelines -&gt; Pipelines and select the FILE-COPY-PROD-CI pipeline. Verify that the pipeline is building. If it wasn’t triggered you will need to trigger it manually.</p>
<p><strong>Step 6:</strong> Go to Pipelines -&gt; Releases and select the FILE-COPY-QA-CD release. Wait for ITS to approve the request, and then verify that the build completes.</p>
<p><strong>Step 7:</strong> Run the <code>RESTARTCONTAINER-PROD-CD</code> release pipeline after the data transfer to the VMs has completed.</p>
<p><strong>Step 8:</strong> Clear the cache on the VMs.</p>
</section>
</section>
<section id="azure-pc-docker" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="azure-pc-docker"><span class="header-section-number">13.2</span> Poverty Calculator Docker image</h2>
<p>Before you start with the application deployment process you will need to clone the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">Azure DevOps Docker</a> repo (DEV branch) to your local machine. You will only need to do this once. After that you can follow the step by step guide below.</p>
<p>Please note that it is important that data changes are pushed through and released before deploying the Docker image. This is because the Docker container will need to restart in order to pick up changes in the mounted folder or volume. The best way to do this is to deploy the data, and then use the API restart pipeline to ensure a restart of the Docker container.</p>
<section id="deploying-image-on-dev" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="deploying-image-on-dev"><span class="header-section-number">13.2.1</span> Deploying image on DEV</h3>
<p><strong>Step 1:</strong> Verify that the latest code in the master branches of {wbpip} and {pipapi} works with the latest data on DEV. This can be done by running the {pipapi} package in a local RStudio session.</p>
<p><strong>Step 2:</strong> <span class="math display">\[Optional\]</span> Verify that the most recent Dockerfile builds on your local machine. This is certainly something that should be done if the contents of the Dockerfile has changed, or before major releases. But in a continuous workflow where you know that Dockerfile hasn’t changed, it might be sufficient to verify that the R packages in question are working.</p>
<p><strong>Step 3:</strong> Navigate to the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">Azure DevOps Docker repo</a>. Go Pipelines -&gt; Pipelines. Trigger the CONTAINER-DEV-CI pipeline, either by<br>
a) Pushing an updated Dockerfile to the remote repo or<br>
b) Running the Pipeline manually.</p>
<p><strong>Step 4:</strong> Go to the Pipelines -&gt; Releases, and select “Create release” in order to run a new deployment. View the logs to see results from the image build and security scan.</p>
<p><strong>Step 5:</strong>. Visit the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">DEV API website</a> for further testing.</p>
</section>
<section id="deploying-image-on-qa" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="deploying-image-on-qa"><span class="header-section-number">13.2.2</span> Deploying image on QA</h3>
<p><strong>Step 1:</strong> Check that the DEV deployment is working correctly.</p>
<p><strong>Step 2:</strong> Make sure the data on QA is up-to-date (in sync with DEV). If it isn’t you will need to create a PR and merge the data first.</p>
<p><strong>Step 3:</strong> Create a pull request from DEV to QA. Go through the steps to commit and approve the pull request. Please make sure that the <strong>“Delete source branch” box is NOT checked</strong>, ie. don’t delete the DEV branch.</p>
<p><strong>Step 4:</strong> Go to the Release pipeline to see results from the image build and security scan.</p>
<p><strong>Step 5:</strong> Visit the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">QA API website</a> for further testing.</p>
</section>
<section id="deploying-image-to-production" class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="deploying-image-to-production"><span class="header-section-number">13.2.3</span> Deploying image to Production</h3>
<p><strong>Step 1:</strong> Check that the QA deployment is working correctly.</p>
<p><strong>Step 2:</strong> Make sure the data on PROD is up-to-date (in sync with QA). If it isn’t you will need to create a PR and merge the data first.</p>
<p><strong>Step 3:</strong> Create a pull request from QA to PROD. Go through the steps to commit and approve the pull request. Please make sure that the <strong>“Delete source branch” box is NOT checked</strong>, ie. don’t delete the QA branch.</p>
<p><strong>Step 4:</strong> Go to the Release pipeline to see results from the image build and security scan.</p>
<p><strong>Step 5:</strong> Visit the <a href="https://github.com/PIP-Technical-Team/PIP_private/blob/main/README.md#resources">PROD API website</a> for further testing.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./docker.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Docker Container</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./workflows.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Github Workflows</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>