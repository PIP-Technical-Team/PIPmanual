<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual</title>
  <meta name="description" content="These are the guidelines to all the technical decisions taken during the creation of packges for the PIP workflow." />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="These are the guidelines to all the technical decisions taken during the creation of packges for the PIP workflow." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual" />
  
  <meta name="twitter:description" content="These are the guidelines to all the technical decisions taken during the creation of packges for the PIP workflow." />
  

<meta name="author" content="DECIS" />
<meta name="author" content="Poverty GP" />


<meta name="date" content="2022-06-23" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="auxiliary-data.html"/>
<link rel="next" href="tmpipelilne.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.21/datatables.js"></script>
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="https://unpkg.com/tachyons@4/css/tachyons.min.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/r-colors.css" type="text/css" />
<link rel="stylesheet" href="css/smltar.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">PIP Internal Guidelines</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome!</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#team"><i class="fa fa-check"></i>Team</a></li>
</ul></li>
<li class="part"><span><b>I Introduction</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#ojectives"><i class="fa fa-check"></i><b>1.1</b> Ojectives</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#technical-requirements"><i class="fa fa-check"></i><b>1.2</b> Technical requirements</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="internal-workflow.html"><a href="internal-workflow.html"><i class="fa fa-check"></i><b>2</b> Internal Workflow</a>
<ul>
<li class="chapter" data-level="2.1" data-path="internal-workflow.html"><a href="internal-workflow.html#the-github-group"><i class="fa fa-check"></i><b>2.1</b> The Github group</a></li>
<li class="chapter" data-level="2.2" data-path="internal-workflow.html"><a href="internal-workflow.html#overview"><i class="fa fa-check"></i><b>2.2</b> Overview</a></li>
<li class="chapter" data-level="2.3" data-path="internal-workflow.html"><a href="internal-workflow.html#data-acquisition"><i class="fa fa-check"></i><b>2.3</b> Data acquisition</a></li>
<li class="chapter" data-level="2.4" data-path="internal-workflow.html"><a href="internal-workflow.html#data-preparation"><i class="fa fa-check"></i><b>2.4</b> Data preparation</a></li>
<li class="chapter" data-level="2.5" data-path="internal-workflow.html"><a href="internal-workflow.html#pre-computed-indicators"><i class="fa fa-check"></i><b>2.5</b> Pre-computed indicators</a></li>
<li class="chapter" data-level="2.6" data-path="internal-workflow.html"><a href="internal-workflow.html#api-feeding"><i class="fa fa-check"></i><b>2.6</b> API feeding</a></li>
<li class="chapter" data-level="2.7" data-path="internal-workflow.html"><a href="internal-workflow.html#packages-interaction"><i class="fa fa-check"></i><b>2.7</b> Packages interaction</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="folder-structure.html"><a href="folder-structure.html"><i class="fa fa-check"></i><b>3</b> Folder Structure</a>
<ul>
<li class="chapter" data-level="3.1" data-path="folder-structure.html"><a href="folder-structure.html#pip-data"><i class="fa fa-check"></i><b>3.1</b> PIP-Data</a></li>
<li class="chapter" data-level="3.2" data-path="folder-structure.html"><a href="folder-structure.html#pip-data_qa"><i class="fa fa-check"></i><b>3.2</b> PIP-Data_QA</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="folder-structure.html"><a href="folder-structure.html#aux"><i class="fa fa-check"></i><b>3.2.1</b> _aux</a></li>
<li class="chapter" data-level="3.2.2" data-path="folder-structure.html"><a href="folder-structure.html#inventory"><i class="fa fa-check"></i><b>3.2.2</b> _inventory</a></li>
<li class="chapter" data-level="3.2.3" data-path="folder-structure.html"><a href="folder-structure.html#country-data"><i class="fa fa-check"></i><b>3.2.3</b> Country data</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="folder-structure.html"><a href="folder-structure.html#pip-data_extsol"><i class="fa fa-check"></i><b>3.3</b> PIP-Data_ExtSOL</a></li>
<li class="chapter" data-level="3.4" data-path="folder-structure.html"><a href="folder-structure.html#pip_data_testing"><i class="fa fa-check"></i><b>3.4</b> PIP_Data_Testing</a></li>
<li class="chapter" data-level="3.5" data-path="folder-structure.html"><a href="folder-structure.html#pip_data_vintage"><i class="fa fa-check"></i><b>3.5</b> PIP_Data_Vintage</a></li>
<li class="chapter" data-level="3.6" data-path="folder-structure.html"><a href="folder-structure.html#pip_ingestion_pipeline"><i class="fa fa-check"></i><b>3.6</b> pip_ingestion_pipeline</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="folder-structure.html"><a href="folder-structure.html#pc_data"><i class="fa fa-check"></i><b>3.6.1</b> pc_data</a></li>
<li class="chapter" data-level="3.6.2" data-path="folder-structure.html"><a href="folder-structure.html#tb_data"><i class="fa fa-check"></i><b>3.6.2</b> tb_data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="joining-data.html"><a href="joining-data.html"><i class="fa fa-check"></i><b>4</b> Joining Data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="joining-data.html"><a href="joining-data.html#pfw-join"><i class="fa fa-check"></i><b>4.1</b> The Price FrameWork (pfw) data</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="joining-data.html"><a href="joining-data.html#joining-data-example"><i class="fa fa-check"></i><b>4.1.1</b> Joining data example</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="joining-data.html"><a href="joining-data.html#special-data-cases"><i class="fa fa-check"></i><b>4.2</b> Special data cases</a></li>
</ul></li>
<li class="part"><span><b>II PIP data</b></span></li>
<li class="chapter" data-level="5" data-path="pfw-chapter.html"><a href="pfw-chapter.html"><i class="fa fa-check"></i><b>5</b> Price FrameWork (pfw) data frame</a>
<ul>
<li class="chapter" data-level="5.1" data-path="pfw-chapter.html"><a href="pfw-chapter.html#variables"><i class="fa fa-check"></i><b>5.1</b> Variables</a></li>
<li class="chapter" data-level="5.2" data-path="pfw-chapter.html"><a href="pfw-chapter.html#additional-explanation"><i class="fa fa-check"></i><b>5.2</b> Additional explanation</a>
<ul>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#id-vars"><i class="fa fa-check"></i>ID vars</a></li>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#altname"><i class="fa fa-check"></i><code>altname</code></a></li>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#survey_coverage"><i class="fa fa-check"></i><code>survey_coverage</code></a></li>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#welfare_type"><i class="fa fa-check"></i><code>welfare_type</code></a></li>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#use_imputed"><i class="fa fa-check"></i><code>use_imputed</code></a></li>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#use_microdata"><i class="fa fa-check"></i><code>use_microdata</code></a></li>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#use_bin"><i class="fa fa-check"></i><code>use_bin</code></a></li>
<li class="chapter" data-level="" data-path="pfw-chapter.html"><a href="pfw-chapter.html#use_groupdata"><i class="fa fa-check"></i><code>use_groupdata</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="primus.html"><a href="primus.html"><i class="fa fa-check"></i><b>6</b> PRIMUS</a>
<ul>
<li class="chapter" data-level="6.1" data-path="primus.html"><a href="primus.html#interacting-with-primus"><i class="fa fa-check"></i><b>6.1</b> Interacting with PRIMUS</a>
<ul>
<li class="chapter" data-level="" data-path="primus.html"><a href="primus.html#website-platform"><i class="fa fa-check"></i>Website platform</a></li>
<li class="chapter" data-level="" data-path="primus.html"><a href="primus.html#stata-command"><i class="fa fa-check"></i>Stata command</a></li>
<li class="chapter" data-level="" data-path="primus.html"><a href="primus.html#corrections-to-primus-stata-command"><i class="fa fa-check"></i>Corrections to <code>primus</code> Stata command</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="primus.html"><a href="primus.html#understand-primus"><i class="fa fa-check"></i><b>6.2</b> Understanding PRIMUS</a></li>
<li class="chapter" data-level="6.3" data-path="primus.html"><a href="primus.html#checking-primus-estimates"><i class="fa fa-check"></i><b>6.3</b> Checking PRIMUS estimates</a></li>
<li class="chapter" data-level="6.4" data-path="primus.html"><a href="primus.html#approve-primus"><i class="fa fa-check"></i><b>6.4</b> Confirming and approving data in PRIMUS</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="welfare-data.html"><a href="welfare-data.html"><i class="fa fa-check"></i><b>7</b> Welfare data</a>
<ul>
<li class="chapter" data-level="7.1" data-path="welfare-data.html"><a href="welfare-data.html#welfare-origin-of-data"><i class="fa fa-check"></i><b>7.1</b> From Raw to GMD</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="welfare-data.html"><a href="welfare-data.html#microdata"><i class="fa fa-check"></i><b>7.1.1</b> Microdata</a></li>
<li class="chapter" data-level="7.1.2" data-path="welfare-data.html"><a href="welfare-data.html#group-data"><i class="fa fa-check"></i><b>7.1.2</b> Group Data</a></li>
<li class="chapter" data-level="7.1.3" data-path="welfare-data.html"><a href="welfare-data.html#bin-data"><i class="fa fa-check"></i><b>7.1.3</b> Bin Data</a></li>
<li class="chapter" data-level="7.1.4" data-path="welfare-data.html"><a href="welfare-data.html#synthetic-data"><i class="fa fa-check"></i><b>7.1.4</b> Synthetic Data</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="welfare-data.html"><a href="welfare-data.html#from-gmd-to-pip"><i class="fa fa-check"></i><b>7.2</b> From GMD to PIP ({pipdp} package)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="welfare-data.html"><a href="welfare-data.html#requirements"><i class="fa fa-check"></i><b>7.2.1</b> Requirements</a></li>
<li class="chapter" data-level="7.2.2" data-path="welfare-data.html"><a href="welfare-data.html#installation"><i class="fa fa-check"></i><b>7.2.2</b> Installation</a></li>
<li class="chapter" data-level="7.2.3" data-path="welfare-data.html"><a href="welfare-data.html#remote-server"><i class="fa fa-check"></i><b>7.2.3</b> Remote server</a></li>
<li class="chapter" data-level="7.2.4" data-path="welfare-data.html"><a href="welfare-data.html#usage"><i class="fa fa-check"></i><b>7.2.4</b> Usage</a></li>
<li class="chapter" data-level="7.2.5" data-path="welfare-data.html"><a href="welfare-data.html#preparing-survey-data-for-poverty-calculator-pipeline"><i class="fa fa-check"></i><b>7.2.5</b> Preparing survey data for Poverty Calculator Pipeline</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="welfare-data.html"><a href="welfare-data.html#survey-id"><i class="fa fa-check"></i><b>7.3</b> Survey ID nomenclature</a></li>
<li class="chapter" data-level="7.4" data-path="welfare-data.html"><a href="welfare-data.html#survey-id-cache"><i class="fa fa-check"></i><b>7.4</b> Survey CACHE ID nomenclature</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="auxiliary-data.html"><a href="auxiliary-data.html"><i class="fa fa-check"></i><b>8</b> Auxiliary data</a>
<ul>
<li class="chapter" data-level="8.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#population"><i class="fa fa-check"></i><b>8.1</b> Population</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#original-data"><i class="fa fa-check"></i><b>8.1.1</b> Original data</a></li>
<li class="chapter" data-level="8.1.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#data-structure"><i class="fa fa-check"></i><b>8.1.2</b> Data structure</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#national-accounts"><i class="fa fa-check"></i><b>8.2</b> National Accounts</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#gdp"><i class="fa fa-check"></i><b>8.2.1</b> GDP</a></li>
<li class="chapter" data-level="8.2.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#consumption-pce"><i class="fa fa-check"></i><b>8.2.2</b> Consumption (PCE)</a></li>
<li class="chapter" data-level="8.2.3" data-path="auxiliary-data.html"><a href="auxiliary-data.html#national-accounts-special-cases"><i class="fa fa-check"></i><b>8.2.3</b> National Accounts, Special Cases</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="auxiliary-data.html"><a href="auxiliary-data.html#cpi"><i class="fa fa-check"></i><b>8.3</b> CPI</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#raw-data"><i class="fa fa-check"></i><b>8.3.1</b> Raw data</a></li>
<li class="chapter" data-level="8.3.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#vintage-control"><i class="fa fa-check"></i><b>8.3.2</b> Vintage control</a></li>
<li class="chapter" data-level="8.3.3" data-path="auxiliary-data.html"><a href="auxiliary-data.html#data-structure-1"><i class="fa fa-check"></i><b>8.3.3</b> Data structure</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="auxiliary-data.html"><a href="auxiliary-data.html#ppp"><i class="fa fa-check"></i><b>8.4</b> PPP</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#raw-data-1"><i class="fa fa-check"></i><b>8.4.1</b> Raw data</a></li>
<li class="chapter" data-level="8.4.2" data-path="auxiliary-data.html"><a href="auxiliary-data.html#data-structure-2"><i class="fa fa-check"></i><b>8.4.2</b> Data structure</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="auxiliary-data.html"><a href="auxiliary-data.html#price-framework-pfw"><i class="fa fa-check"></i><b>8.5</b> Price FrameWork (PFW)</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="auxiliary-data.html"><a href="auxiliary-data.html#original-data-1"><i class="fa fa-check"></i><b>8.5.1</b> Original data</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="auxiliary-data.html"><a href="auxiliary-data.html#abbreviations"><i class="fa fa-check"></i><b>8.6</b> Abbreviations</a></li>
</ul></li>
<li class="part"><span><b>III PIP Procedures</b></span></li>
<li class="chapter" data-level="9" data-path="pcpipeline.html"><a href="pcpipeline.html"><i class="fa fa-check"></i><b>9</b> Poverty Calculator Pipeline (pre-computed estimations)</a>
<ul>
<li class="chapter" data-level="9.1" data-path="pcpipeline.html"><a href="pcpipeline.html#folder-structure-1"><i class="fa fa-check"></i><b>9.1</b> Folder structure</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#folders"><i class="fa fa-check"></i>Folders</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#files"><i class="fa fa-check"></i>Files</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="pcpipeline.html"><a href="pcpipeline.html#prerequisites"><i class="fa fa-check"></i><b>9.2</b> Prerequisites</a></li>
<li class="chapter" data-level="9.3" data-path="pcpipeline.html"><a href="pcpipeline.html#structure-of-the-_targets.r-file"><i class="fa fa-check"></i><b>9.3</b> Structure of the <code>_targets.R</code> file</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#start-up"><i class="fa fa-check"></i>Start up</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#step-1-small-functions"><i class="fa fa-check"></i>Step 1: small functions</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#step-2-preparing-the-data"><i class="fa fa-check"></i>Step 2: preparing the data</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#step-3-the-actual-pipeline"><i class="fa fa-check"></i>Step 3: The actual pipeline</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="pcpipeline.html"><a href="pcpipeline.html#understanding-the-pipeline"><i class="fa fa-check"></i><b>9.4</b> Understanding the pipeline</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#stem-targets"><i class="fa fa-check"></i>Stem targets</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#branches-targets"><i class="fa fa-check"></i>Branches targets</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#creating-the-cache-files"><i class="fa fa-check"></i>Creating the cache files</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="pcpipeline.html"><a href="pcpipeline.html#understanding-pipdm-functions"><i class="fa fa-check"></i><b>9.5</b> Understanding <code>{pipdm}</code> functions</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="pcpipeline.html"><a href="pcpipeline.html#internal-structure-of-pipdm-functions"><i class="fa fa-check"></i><b>9.5.1</b> Internal structure of <code>{pipdm}</code> functions</a></li>
<li class="chapter" data-level="9.5.2" data-path="pcpipeline.html"><a href="pcpipeline.html#updating-pipdm-or-any-other-pip-package"><i class="fa fa-check"></i><b>9.5.2</b> Updating <code>{pipdm}</code> (or any other PIP package)</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="pcpipeline.html"><a href="pcpipeline.html#executing-the-_targets.r-file"><i class="fa fa-check"></i><b>9.6</b> Executing the <code>_targets.R</code> file</a></li>
<li class="chapter" data-level="9.7" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging"><i class="fa fa-check"></i><b>9.7</b> Debugging</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging-stem-targets"><i class="fa fa-check"></i>Debugging stem targets</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging-branch-targets"><i class="fa fa-check"></i>Debugging branch targets</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="tmpipelilne.html"><a href="tmpipelilne.html"><i class="fa fa-check"></i><b>10</b> Table Maker Pipeline</a></li>
<li class="part"><span><b>IV Standalone Technical Considerations</b></span></li>
<li class="chapter" data-level="11" data-path="load.html"><a href="load.html"><i class="fa fa-check"></i><b>11</b> Load microdata and Auxiliary data</a>
<ul>
<li class="chapter" data-level="11.1" data-path="load.html"><a href="load.html#auxiilary-data"><i class="fa fa-check"></i><b>11.1</b> Auxiilary data</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="load.html"><a href="load.html#udpate-data"><i class="fa fa-check"></i><b>11.1.1</b> udpate data</a></li>
<li class="chapter" data-level="11.1.2" data-path="load.html"><a href="load.html#load-data"><i class="fa fa-check"></i><b>11.1.2</b> Load data</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="load.html"><a href="load.html#microdata-1"><i class="fa fa-check"></i><b>11.2</b> Microdata</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="load.html"><a href="load.html#inventory-file"><i class="fa fa-check"></i><b>11.2.1</b> Inventory file</a></li>
<li class="chapter" data-level="11.2.2" data-path="load.html"><a href="load.html#finding-data"><i class="fa fa-check"></i><b>11.2.2</b> Finding data</a></li>
<li class="chapter" data-level="11.2.3" data-path="load.html"><a href="load.html#loading-data"><i class="fa fa-check"></i><b>11.2.3</b> Loading data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="pc-docker.html"><a href="pc-docker.html"><i class="fa fa-check"></i><b>12</b> Docker Container</a>
<ul>
<li class="chapter" data-level="12.1" data-path="pc-docker.html"><a href="pc-docker.html#introduction"><i class="fa fa-check"></i><b>12.1</b> Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="pcpipeline.html"><a href="pcpipeline.html#prerequisites"><i class="fa fa-check"></i><b>12.2</b> Prerequisites</a></li>
<li class="chapter" data-level="12.3" data-path="pc-docker.html"><a href="pc-docker.html#docker-on-world-bank-laptops"><i class="fa fa-check"></i><b>12.3</b> Docker on World Bank laptops</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="pc-docker.html"><a href="pc-docker.html#wb-docker-install"><i class="fa fa-check"></i><b>12.3.1</b> Install Docker</a></li>
<li class="chapter" data-level="12.3.2" data-path="pc-docker.html"><a href="pc-docker.html#known-problems-and-solutions"><i class="fa fa-check"></i><b>12.3.2</b> Known problems and solutions</a></li>
<li class="chapter" data-level="12.3.3" data-path="pc-docker.html"><a href="pc-docker.html#tips-and-tricks"><i class="fa fa-check"></i><b>12.3.3</b> Tips and tricks</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="pc-docker.html"><a href="pc-docker.html#create-volume"><i class="fa fa-check"></i><b>12.4</b> Create volume</a></li>
<li class="chapter" data-level="12.5" data-path="pc-docker.html"><a href="pc-docker.html#build-image"><i class="fa fa-check"></i><b>12.5</b> Build image</a></li>
<li class="chapter" data-level="12.6" data-path="pc-docker.html"><a href="pc-docker.html#run-container"><i class="fa fa-check"></i><b>12.6</b> Run container</a></li>
<li class="chapter" data-level="12.7" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging"><i class="fa fa-check"></i><b>12.7</b> Debugging</a></li>
<li class="chapter" data-level="12.8" data-path="pc-docker.html"><a href="pc-docker.html#security"><i class="fa fa-check"></i><b>12.8</b> Security</a></li>
<li class="chapter" data-level="12.9" data-path="pc-docker.html"><a href="pc-docker.html#base-image-options"><i class="fa fa-check"></i><b>12.9</b> Base image options</a></li>
<li class="chapter" data-level="12.10" data-path="pc-docker.html"><a href="pc-docker.html#using-r-on-linux"><i class="fa fa-check"></i><b>12.10</b> Using R on Linux</a></li>
<li class="chapter" data-level="12.11" data-path="pc-docker.html"><a href="pc-docker.html#resources"><i class="fa fa-check"></i><b>12.11</b> Resources</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="azure.html"><a href="azure.html"><i class="fa fa-check"></i><b>13</b> Deploying to Azure</a>
<ul>
<li class="chapter" data-level="13.1" data-path="azure.html"><a href="azure.html#azure-pc-data"><i class="fa fa-check"></i><b>13.1</b> Poverty Calculator Data</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="azure.html"><a href="azure.html#deploying-data-on-dev"><i class="fa fa-check"></i><b>13.1.1</b> Deploying data on DEV</a></li>
<li class="chapter" data-level="13.1.2" data-path="azure.html"><a href="azure.html#deploying-data-on-qa"><i class="fa fa-check"></i><b>13.1.2</b> Deploying data on QA</a></li>
<li class="chapter" data-level="13.1.3" data-path="azure.html"><a href="azure.html#deploying-data-to-production"><i class="fa fa-check"></i><b>13.1.3</b> Deploying data to Production</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="azure.html"><a href="azure.html#azure-pc-docker"><i class="fa fa-check"></i><b>13.2</b> Poverty Calculator Docker image</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="azure.html"><a href="azure.html#deploying-image-on-dev"><i class="fa fa-check"></i><b>13.2.1</b> Deploying image on DEV</a></li>
<li class="chapter" data-level="13.2.2" data-path="azure.html"><a href="azure.html#deploying-image-on-qa"><i class="fa fa-check"></i><b>13.2.2</b> Deploying image on QA</a></li>
<li class="chapter" data-level="13.2.3" data-path="azure.html"><a href="azure.html#deploying-image-to-production"><i class="fa fa-check"></i><b>13.2.3</b> Deploying image to Production</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="gh-workflows.html"><a href="gh-workflows.html"><i class="fa fa-check"></i><b>14</b> Github Workflows</a>
<ul>
<li class="chapter" data-level="14.1" data-path="gh-workflows.html"><a href="gh-workflows.html#package-webpage-using-pkgdown"><i class="fa fa-check"></i><b>14.1</b> Package webpage using <code>{pkgdown}</code></a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="gh-workflows.html"><a href="gh-workflows.html#create-gh-pages-branch"><i class="fa fa-check"></i><b>14.1.1</b> Create <code>gh-pages</code> branch</a></li>
<li class="chapter" data-level="14.1.2" data-path="gh-workflows.html"><a href="gh-workflows.html#create-setup-files"><i class="fa fa-check"></i><b>14.1.2</b> Create “setup” files</a></li>
<li class="chapter" data-level="14.1.3" data-path="gh-workflows.html"><a href="gh-workflows.html#activate-github-pages"><i class="fa fa-check"></i><b>14.1.3</b> Activate Github Pages</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="gh-workflows.html"><a href="gh-workflows.html#package-build-checks"><i class="fa fa-check"></i><b>14.2</b> Package build checks</a></li>
<li class="chapter" data-level="14.3" data-path="gh-workflows.html"><a href="gh-workflows.html#code-coverage"><i class="fa fa-check"></i><b>14.3</b> Code coverage</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="gh-workflows.html"><a href="gh-workflows.html#create-setup-files-1"><i class="fa fa-check"></i><b>14.3.1</b> Create “setup” files</a></li>
<li class="chapter" data-level="14.3.2" data-path="gh-workflows.html"><a href="gh-workflows.html#integrate-with-codecov.io"><i class="fa fa-check"></i><b>14.3.2</b> Integrate with codecov.io</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="gh-workflows.html"><a href="gh-workflows.html#other-workflows"><i class="fa fa-check"></i><b>14.4</b> Other workflows</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="subtrees.html"><a href="subtrees.html"><i class="fa fa-check"></i><b>15</b> Subtrees using Smartgit</a>
<ul>
<li class="chapter" data-level="15.1" data-path="subtrees.html"><a href="subtrees.html#note"><i class="fa fa-check"></i><b>15.1</b> NOTE:</a></li>
<li class="chapter" data-level="15.2" data-path="subtrees.html"><a href="subtrees.html#subtrees-in-the-ui"><i class="fa fa-check"></i><b>15.2</b> <strong>Subtrees in the UI</strong></a></li>
<li class="chapter" data-level="15.3" data-path="subtrees.html"><a href="subtrees.html#basic-subtree-operations"><i class="fa fa-check"></i><b>15.3</b> <strong>Basic Subtree operations</strong></a></li>
<li class="chapter" data-level="15.4" data-path="subtrees.html"><a href="subtrees.html#synchronizing-changes-back-to-the-subtree-repository"><i class="fa fa-check"></i><b>15.4</b> <strong>Synchronizing changes back to the subtree repository</strong></a>
<ul>
<li class="chapter" data-level="15.4.1" data-path="subtrees.html"><a href="subtrees.html#using-push"><i class="fa fa-check"></i><b>15.4.1</b> Using Push</a></li>
<li class="chapter" data-level="15.4.2" data-path="subtrees.html"><a href="subtrees.html#using-split"><i class="fa fa-check"></i><b>15.4.2</b> Using Split</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="subtrees.html"><a href="subtrees.html#information"><i class="fa fa-check"></i><b>15.5</b> Information</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/PIP-Technical-Team/PIPmanual" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">PIP Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div class="rmdbox rmdwarning"><strong>DISCLAIMER:</strong> This book contains relevant only for the internal Technical team of the PIP project. It has been made available to the public for the sake of transparency, but its information has no use outside the internal team.
 </div>
<div id="pcpipeline" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Poverty Calculator Pipeline (pre-computed estimations)<a href="pcpipeline.html#pcpipeline" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The Poverty Calculator Pipeline–hereafter, and only for the rest of this chapter, pipeline–is the technical procedure to calculate the pre-computed (or statitic) estimations of the PIP project. These estimations have two main purposes:</p>
<ol style="list-style-type: decimal">
<li>To provide the user with instantaneous information about distributive measures of all the household surveys in the PIP repository that do not depend on the value of the poverty line (e.g. mean income, quantiles). Avoiding thus the need for re-computation as it was the case in PovcalNet for some of these measures.</li>
<li>To provide the necessary inputs to the PIP API.</li>
</ol>
<p>This chapter walks you through the folder structure of the folder, the main R script, <code>_targets.R</code>, and the complete and partial execution of the script. Also, it provides some tips for debugging.</p>
<div id="folder-structure-1" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Folder structure<a href="pcpipeline.html#folder-structure-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The pipeline is hosted in the Github repository <a href="https://github.com/PIP-Technical-Team/pip_ingestion_pipeline">PIP-Technical-Team/pip_ingestion_pipeline</a>. At the root of the repo you will find a series of files and folders.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="pcpipeline.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- batch</span></span>
<span id="cb40-2"><a href="pcpipeline.html#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- pip_ingestion_pipeline.Rproj</span></span>
<span id="cb40-3"><a href="pcpipeline.html#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- R</span></span>
<span id="cb40-4"><a href="pcpipeline.html#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- README.md</span></span>
<span id="cb40-5"><a href="pcpipeline.html#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- renv</span></span>
<span id="cb40-6"><a href="pcpipeline.html#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- renv.lock</span></span>
<span id="cb40-7"><a href="pcpipeline.html#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- run.R</span></span>
<span id="cb40-8"><a href="pcpipeline.html#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- _packages.R</span></span>
<span id="cb40-9"><a href="pcpipeline.html#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; \-- _targets</span></span>
<span id="cb40-10"><a href="pcpipeline.html#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; \-- _targets.R</span></span></code></pre></div>
<div id="folders" class="section level3 unnumbered hasAnchor">
<h3>Folders<a href="pcpipeline.html#folders" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p><code>R</code> contains long R functions used during the pipeline</p></li>
<li><p><code>batch</code> is a script for timing the execution of the pipeline. This folder should probably be removed</p></li>
<li><p><code>_targets</code> is a folder for all objects created during the pipeline. You don’t need to look inside as its content is managed by the <code>targets</code> package.</p></li>
<li><p><code>renv</code> is a folder for reproducible environment.</p></li>
</ul>
</div>
<div id="files" class="section level3 unnumbered hasAnchor">
<h3>Files<a href="pcpipeline.html#files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p><code>_packages.R</code> is created by <code>targets::tar_renv()</code>. Do not modify manually.</p></li>
<li><p><code>_targets.R</code> contains the pipeline. This is the most important file.</p></li>
</ul>
</div>
</div>
<div id="prerequisites" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Prerequisites<a href="pcpipeline.html#prerequisites" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before you start working on the pipeline, you need to make sure to have the following PIP packages.</p>
<blockquote>
<p><strong>Note 1</strong>: notice that instructions below contain suffixes like <code>@development</code>. These specify the branch of the particular package that you need to use. Ideally, all packages should use the master branch; however, that will only be possible until the end of the development process.</p>
</blockquote>
<blockquote>
<p><strong>Note 2</strong>: if you update any of the packages developed by the PIP team, make sure you always increased the version of the package using the function <code>usethis::use_version()</code>. Even if the change in the package is small, you need on increased the version of the package. Otherwise, <code>{targets}</code> won’t execute the sections of the pipeline that run the functions you changed.</p>
</blockquote>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="pcpipeline.html#cb41-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/pipdm@development&quot;</span>)</span>
<span id="cb41-2"><a href="pcpipeline.html#cb41-2" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/pipload@development&quot;</span>)</span>
<span id="cb41-3"><a href="pcpipeline.html#cb41-3" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/wbpip@halfmedian_spl&quot;</span>)</span>
<span id="cb41-4"><a href="pcpipeline.html#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;joyn&quot;</span>)</span></code></pre></div>
<p>In case <code>renv</code> is not working for you, you may need to install all the packages mentioned in the <code>_packages.R</code> script at the root of the folder. Also, make sure to install the most recent version of <code>targets</code> and <code>tarchetypes</code> packages.</p>
</div>
<div id="structure-of-the-_targets.r-file" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Structure of the <code>_targets.R</code> file<a href="pcpipeline.html#structure-of-the-_targets.r-file" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Even thought the pipeline script looks like a regular R script, it is structured in a specific way in order to make it work with the <a href="https://books.ropensci.org/targets/"><code>{targets}</code></a> package. In fact, notice that it must be called <code>_targets.R</code> at the root of the project. It is highly recommended that you read the entire <a href="https://books.ropensci.org/targets/">targets manual</a> to fully understand how it works. We will often be referring to such manual in order to expand on any particular targets’ concept.</p>
<div id="start-up" class="section level3 unnumbered hasAnchor">
<h3>Start up<a href="pcpipeline.html#start-up" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first part of the pipeline sets up the environment. The process involve,</p>
<ol style="list-style-type: decimal">
<li>loading the <code>{targets}</code> and <code>{tarchetypes}</code> packages;</li>
</ol>
<!-- -->
<ol start="2" style="list-style-type: decimal">
<li>creating default values like directories, time stamps, survey and reference years boundaries, compression level of .fst files, etc.;</li>
<li>executing <code>tar_option_set()</code> to set up an option in <code>{targets}</code>. <code>packages</code> and <code>imports</code> are two particularly important options to track changes in package dependencies. You can read more about it in the sections <a href="https://books.ropensci.org/targets/practices.html#loading-and-configuring-r-packages">Loading and configuring R packages</a> and <a href="https://books.ropensci.org/targets/practices.html#packages-based-invalidation">Packages-based invalidation</a> of the targets manual;</li>
<li>attaching all the packages and functions of the project by running <code>source('_packages.R')</code> and <code>source('R/_common.R')</code>.</li>
</ol>
</div>
<div id="step-1-small-functions" class="section level3 unnumbered hasAnchor">
<h3>Step 1: small functions<a href="pcpipeline.html#step-1-small-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>According to the section <a href="https://books.ropensci.org/targets/functions.html#functions-in-pipelines">Functions in pipelines</a> of the targets manual, it is recommend to only use functions rather than expressions during the executions. Presumably, the reason for this is that targets track changes in functions but not in expressions. Thus, this scripts section defines small functions that are executed along the pipeline. In the section above, the scripts <code>source('R/_common.R')</code> loads longer functions. Yet, keep in mind that the <code>'R/_common.R'</code> was used in a previous version of the pipeline before <code>{targets}</code> was implemented. Now, most of the function in <code>'R/_common.R'</code> are included in the <code>{pipdm}</code> package.</p>
</div>
<div id="step-2-preparing-the-data" class="section level3 unnumbered hasAnchor">
<h3>Step 2: preparing the data<a href="pcpipeline.html#step-2-preparing-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><span style="color:red">This section used to be longer in previous versions of the pipeline because it used to identify the auxiliary data, load the PIP microdata inventory, and create the cache files. It now only identifies the auxiliary data.</span></p>
</div>
<div id="step-3-the-actual-pipeline" class="section level3 unnumbered hasAnchor">
<h3>Step 3: The actual pipeline<a href="pcpipeline.html#step-3-the-actual-pipeline" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Although better explained in the next section, the overall order of the pipeline is as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Load all necessary data (that is, auxiliary data and inventories), and then create any cache fie that has not been created yet.</p></li>
<li><p>Calculate means in LCU</p></li>
<li><p>Crate deflated survey mean (DSM) table</p></li>
<li><p>Calculate reference year table (aka., interpolated means table)</p></li>
<li><p>Calculate distributional stats</p></li>
<li><p>Create output tables</p>
<ol style="list-style-type: decimal">
<li><p>join survey mean table with dist table</p></li>
<li><p>join reference year table with dist table</p></li>
<li><p>coverage table aggregate population at the regional level table</p></li>
</ol></li>
<li><p>Clean and save.</p></li>
</ol>
</div>
</div>
<div id="understanding-the-pipeline" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> Understanding the pipeline<a href="pcpipeline.html#understanding-the-pipeline" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We must understand not only how the <code>{targets}</code> package works, but also how the targets of the Poverty Calculator Pipeline are created. For the former, you can read the targets manual. For the latter, we should start by making a distinction between the different types of targets.</p>
<p>In <code>{targets}</code> terminology, there are two kinds of targets, <strong>stems</strong> and <strong>branches</strong>. <strong>Stems</strong> are unitary targets. That is, for each target there is only one single R object. <strong>Branches</strong>, on the other hand, are targets that contain several objects or <em>subtargets</em> inside (you can learn more about them in the chapter <a href="https://books.ropensci.org/targets/dynamic.html#dynamic">Dynamic branching</a> of the targets manual). We will see the use of this type of targets when we talk about the use of cache files.</p>
<div id="stem-targets" class="section level3 unnumbered hasAnchor">
<h3>Stem targets<a href="pcpipeline.html#stem-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There are two ways to create <strong>stem</strong> targets: either using <code>tar_target()</code> or using <code>tar_map()</code> from the <code>{tarchetypes}</code> package. The <code>tar_map()</code> function allows to create <strong>stem</strong> targets iteratively. See for instance the creation of targets for each auxiliary data:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="pcpipeline.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_map</span>(</span>
<span id="cb42-2"><a href="pcpipeline.html#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> aux_tb, </span>
<span id="cb42-3"><a href="pcpipeline.html#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">names  =</span> <span class="st">&quot;auxname&quot;</span>, </span>
<span id="cb42-4"><a href="pcpipeline.html#cb42-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-5"><a href="pcpipeline.html#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create dynamic name</span></span>
<span id="cb42-6"><a href="pcpipeline.html#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb42-7"><a href="pcpipeline.html#cb42-7" aria-hidden="true" tabindex="-1"></a>    aux_dir,</span>
<span id="cb42-8"><a href="pcpipeline.html#cb42-8" aria-hidden="true" tabindex="-1"></a>    auxfiles, </span>
<span id="cb42-9"><a href="pcpipeline.html#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">&quot;file&quot;</span></span>
<span id="cb42-10"><a href="pcpipeline.html#cb42-10" aria-hidden="true" tabindex="-1"></a>  ), </span>
<span id="cb42-11"><a href="pcpipeline.html#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb42-12"><a href="pcpipeline.html#cb42-12" aria-hidden="true" tabindex="-1"></a>    aux,</span>
<span id="cb42-13"><a href="pcpipeline.html#cb42-13" aria-hidden="true" tabindex="-1"></a>    pipload<span class="sc">::</span><span class="fu">pip_load_aux</span>(<span class="at">file_to_load =</span> aux_dir,</span>
<span id="cb42-14"><a href="pcpipeline.html#cb42-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">apply_label =</span> <span class="cn">FALSE</span>)</span>
<span id="cb42-15"><a href="pcpipeline.html#cb42-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-16"><a href="pcpipeline.html#cb42-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-17"><a href="pcpipeline.html#cb42-17" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><code>tar_map()</code> takes the values in the data frame <code>aux_tb</code> created in <a href="pcpipeline.html#step-2-preparing-the-data">Step 2: preparing the data</a> and creates two type of targets. First, it creates the target <code>aux_dir</code> that contains the paths of the auxiliary files, which are available in the column <code>auxfiles</code> of <code>aux_tb</code>. This is done by creating an internal target within <code>tar_map()</code> and using the argument <code>format = "file"</code>. This process lets <code>{targets}</code> know that we will have objects that are loaded from a file and are not created inside the pc pipeline.</p>
<p>Then, <code>tar_map()</code> uses the the column <code>auxname</code> of <code>aux_tb</code> to name the targets that contain the auxiliary files. Each target will be prefixed by the word “aux”. This is why we had to add the argument <code>file_to_load</code> to <code>pipload::pip_load_aux</code>, so we can let <code>{targets}</code> know that the file paths defined in target <code>aux_dir</code> are used to create the targets prefixed with “aux”, which are the actual targets. For example, if I need to use the population data frame inside the pc pipeline, I’d use the target <code>aux_pop</code>, which had a corresponding file path in <code>aux_dir</code>. This way, if the original file referenced in <code>aux_dir</code> changes, all the targets that depend on <code>aux_pop</code> will be run again.</p>
</div>
<div id="branches-targets" class="section level3 unnumbered hasAnchor">
<h3>Branches targets<a href="pcpipeline.html#branches-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><span style="color:red">Let’s think of a branch target like…</span></p>
<p>As explained above, branch targets are targets made of many “subtargets” that follow a particular pattern. Most of the targets created in the pc pipeline are <strong>branch</strong> targets because we need to execute the same procedure in every cache file. This could have been done internally in a single one, but then we would lose the tracking features of <code>{targets}</code>. Additionally, we could have created a <strong>stem</strong> target for every cache file, result, and output file, but that would have been both impossible to visualize and more difficult to code. Hence, branch targets is the best option.</p>
<p>The following example illustrates how it works,</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="pcpipeline.html#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="pcpipeline.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># step A</span></span>
<span id="cb43-3"><a href="pcpipeline.html#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb43-4"><a href="pcpipeline.html#cb43-4" aria-hidden="true" tabindex="-1"></a>  cache_inventory_dir, </span>
<span id="cb43-5"><a href="pcpipeline.html#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cache_inventory_path</span>(),</span>
<span id="cb43-6"><a href="pcpipeline.html#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">&quot;file&quot;</span></span>
<span id="cb43-7"><a href="pcpipeline.html#cb43-7" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb43-8"><a href="pcpipeline.html#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="pcpipeline.html#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># step B</span></span>
<span id="cb43-10"><a href="pcpipeline.html#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb43-11"><a href="pcpipeline.html#cb43-11" aria-hidden="true" tabindex="-1"></a>  cache_inventory, </span>
<span id="cb43-12"><a href="pcpipeline.html#cb43-12" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb43-13"><a href="pcpipeline.html#cb43-13" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> fst<span class="sc">::</span><span class="fu">read_fst</span>(cache_inventory_dir, </span>
<span id="cb43-14"><a href="pcpipeline.html#cb43-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">as.data.table =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-15"><a href="pcpipeline.html#cb43-15" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb43-16"><a href="pcpipeline.html#cb43-16" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb43-17"><a href="pcpipeline.html#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="pcpipeline.html#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="co"># step C</span></span>
<span id="cb43-19"><a href="pcpipeline.html#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(cache_files,</span>
<span id="cb43-20"><a href="pcpipeline.html#cb43-20" aria-hidden="true" tabindex="-1"></a>           <span class="fu">get_cache_files</span>(cache_inventory)),</span>
<span id="cb43-21"><a href="pcpipeline.html#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="pcpipeline.html#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="co"># step D</span></span>
<span id="cb43-23"><a href="pcpipeline.html#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_files</span>(cache_dir, cache_files),</span>
<span id="cb43-24"><a href="pcpipeline.html#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="pcpipeline.html#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># step E</span></span>
<span id="cb43-26"><a href="pcpipeline.html#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(cache, </span>
<span id="cb43-27"><a href="pcpipeline.html#cb43-27" aria-hidden="true" tabindex="-1"></a>           fst<span class="sc">::</span><span class="fu">read_fst</span>(<span class="at">path =</span> cache_dir, </span>
<span id="cb43-28"><a href="pcpipeline.html#cb43-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">as.data.table =</span> <span class="cn">TRUE</span>), </span>
<span id="cb43-29"><a href="pcpipeline.html#cb43-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="fu">map</span>(cache_dir), </span>
<span id="cb43-30"><a href="pcpipeline.html#cb43-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">iteration =</span> <span class="st">&quot;list&quot;</span>)</span></code></pre></div>
<p>The code above illustrates several things. It is divided in steps, with the last step (step E) being the part of the code where the <strong>branch</strong> target is created. Yet, it is important to understand all the previous steps.</p>
<p>In step A we create target <code>cache_inventory_dir</code>, which is merely the file path that contains the cache inventory. Notice that it is returned by a function and not entered directly into the target. Since it is a file path, we need to add the argument <code>format = "file"</code> to let <code>{targets}</code> know that it is input data. In step B we load the cache inventory file into target <code>cache_inventory</code> by providing the target “path” that we created in step A. This file has several columns. One of them contains the file path of every single cache file in the PIP network drive. That single column is extracted from the cache inventory in step C. Then, in step D, each file path is declared as input, using the convenient function <code>tar_files()</code>, creating thus a new target, <code>cache_dir</code>. Finally, we create <strong>branch</strong> target <code>cache</code> with all the cache files by loading each file. To do this iteratively, we parse the <code>cache_dir</code> target to the <code>path</code> argument of the function <code>fst::read_fst()</code> and to the <code>pattern = map()</code> argument of the <code>tar_target()</code> function. At the very end, we need to specify that the output of the iteration is stored as a list, using the argument <code>iteration = "list"</code>.</p>
<p>The basic logic of <strong>branch</strong> targets is that the vector or list to iterate through should be parsed to the function’s argument and to the <code>pattern = map()</code> argument of the <code>tar_target()</code> function. It is very similar to <code>purrr::map()</code></p>
<blockquote>
<p><strong>Note</strong>: if we are iterating through <em>more than one</em> vector or list, you need to (1) separate each of them by commas in the <code>map()</code> part of the argument (See example code below). (2) make sure all the vectors or lists <strong>have the same length</strong>. This is why we cannot remove NULL or NA values from any target. (3) make sure you do <strong>NOT</strong> sort any of the output targets as it will loose its correspondence with other targets.</p>
</blockquote>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="pcpipeline.html#cb44-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-2"><a href="pcpipeline.html#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Example of creating branch target using several lists to iterate through.</span></span>
<span id="cb44-3"><a href="pcpipeline.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb44-4"><a href="pcpipeline.html#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">name      =</span> dl_dist_stats,</span>
<span id="cb44-5"><a href="pcpipeline.html#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">command   =</span> <span class="fu">db_compute_dist_stats</span>(<span class="at">dt       =</span> cache, </span>
<span id="cb44-6"><a href="pcpipeline.html#cb44-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">mean     =</span> dl_mean, </span>
<span id="cb44-7"><a href="pcpipeline.html#cb44-7" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">pop      =</span> aux_pop, </span>
<span id="cb44-8"><a href="pcpipeline.html#cb44-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">cache_id =</span> cache_ids), </span>
<span id="cb44-9"><a href="pcpipeline.html#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern   =</span>  <span class="fu">map</span>(cache, dl_mean, cache_ids), </span>
<span id="cb44-10"><a href="pcpipeline.html#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="st">&quot;list&quot;</span></span>
<span id="cb44-11"><a href="pcpipeline.html#cb44-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="creating-the-cache-files" class="section level3 unnumbered hasAnchor">
<h3>Creating the cache files<a href="pcpipeline.html#creating-the-cache-files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following code illustrates the creation of cache files:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="pcpipeline.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(pipeline_inventory, {</span>
<span id="cb45-2"><a href="pcpipeline.html#cb45-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> pipdm<span class="sc">::</span><span class="fu">db_filter_inventory</span>(</span>
<span id="cb45-3"><a href="pcpipeline.html#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">dt =</span> pip_inventory,</span>
<span id="cb45-4"><a href="pcpipeline.html#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pfw_table =</span> aux_pfw)</span>
<span id="cb45-5"><a href="pcpipeline.html#cb45-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-6"><a href="pcpipeline.html#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uncomment for specific countries</span></span>
<span id="cb45-7"><a href="pcpipeline.html#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># x &lt;- x[country_code == &#39;IDN&#39; &amp; surveyid_year == 2015]</span></span>
<span id="cb45-8"><a href="pcpipeline.html#cb45-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-9"><a href="pcpipeline.html#cb45-9" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb45-10"><a href="pcpipeline.html#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(status_cache_files_creation, </span>
<span id="cb45-11"><a href="pcpipeline.html#cb45-11" aria-hidden="true" tabindex="-1"></a>           pipdm<span class="sc">::</span><span class="fu">create_cache_file</span>(</span>
<span id="cb45-12"><a href="pcpipeline.html#cb45-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">pipeline_inventory =</span> pipeline_inventory,</span>
<span id="cb45-13"><a href="pcpipeline.html#cb45-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">pip_data_dir       =</span> PIP_DATA_DIR,</span>
<span id="cb45-14"><a href="pcpipeline.html#cb45-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">tool               =</span> <span class="st">&quot;PC&quot;</span>,</span>
<span id="cb45-15"><a href="pcpipeline.html#cb45-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">cache_svy_dir      =</span> CACHE_SVY_DIR,</span>
<span id="cb45-16"><a href="pcpipeline.html#cb45-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">compress           =</span> FST_COMP_LVL,</span>
<span id="cb45-17"><a href="pcpipeline.html#cb45-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">force              =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-18"><a href="pcpipeline.html#cb45-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">verbose            =</span> <span class="cn">FALSE</span>,</span>
<span id="cb45-19"><a href="pcpipeline.html#cb45-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">cpi_dt             =</span> aux_cpi,</span>
<span id="cb45-20"><a href="pcpipeline.html#cb45-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">ppp_dt             =</span> aux_ppp)</span>
<span id="cb45-21"><a href="pcpipeline.html#cb45-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>It is important to understand this part of the pc pipeline thoroughly because the cache files used to be created in <a href="pcpipeline.html#step-2-preparing-the-data">Step 2: preparing the data</a> rather than here. Now, it has not only been integrated in the pc pipeline, but it is also possible to execute the creation of cache files independently from the rest of the pipeline, by following the instructions in [Executing the _targets.R file].</p>
<p>The first target, <code>pipeline_inventory</code> is just the inner join of the pip inventory dataset and the price framework (pfw) file, to make sure we only include what the <strong>pfw</strong> says. This data set also contains a lot of useful information to create the cache files. Note that the commented line in this target would filter the pipeline inventory to have only the information for IDN, 2015. <span style="color:red">If you need to update specific cache files, you must add the proper filtering condition there</span>.</p>
<p>In the second target, <code>status_cache_files_creation</code>, you will create the cache files but notice that the returning value of the function <code>pipdm::create_cache_file()</code> is not the cache file per-se, but a list with the status of the creation process. If the creation of a particular file fails, it does not stop the iteration that creates all the cache files. At the end of the process, it returns a list with the creation status of each cache file. Notice that the function <code>pipdm::create_cache_file()</code> requires the CPI and the PPP auxiliary data. That is because the variable <code>welfare_ppp</code>, which is the welfare aggregate in 2011 PPP values, is added to the cache files. FInally, and more importantly, the argument <code>force = TRUE</code> ensures that even if the cache file already exists, it should be modified. This is important when you require additional features in the cache file from the then ones it currently has. If set to <code>TRUE</code>, it will replace any file in the network drive that is listed in <code>pipeline_inventory</code>. If set to <code>FALSE</code>, only the files that are in <code>pipeline_inventory</code> -but not in the cache folder- will be created. Use this option only when you need to add new features to all cache data, or when you are testing and only need a few surveys with the new features.</p>
</div>
</div>
<div id="understanding-pipdm-functions" class="section level2 hasAnchor" number="9.5">
<h2><span class="header-section-number">9.5</span> Understanding <code>{pipdm}</code> functions<a href="pcpipeline.html#understanding-pipdm-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>{pipdm}</code> package is the backbone of the pc pipeline. It is in charge of executing the functions in <code>{wbpip}</code> and consolidate the new DataBases. This is why many of the functions in <code>{pipdm}</code> are prefixed with “db_”.</p>
<div id="internal-structure-of-pipdm-functions" class="section level3 hasAnchor" number="9.5.1">
<h3><span class="header-section-number">9.5.1</span> Internal structure of <code>{pipdm}</code> functions<a href="pcpipeline.html#internal-structure-of-pipdm-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The main objective of <code>{pipdm}</code> is to execute the functions in <code>{wbpip}</code> to do the calculations and then build the data frames. As of today (2022-06-23), the process is a little intricate.</p>
<p>Let’s take the example of estimating distributive measures in the pipeline. The image <a href="pcpipeline.html#pipdm-structure">below</a> shows that there are at least three intermediate function levels between the <code>db_compute_dist_stats()</code> function, which is directly executed in the pc pipeline, and the <code>wbpip::md_compute_dist_stats()</code>, which makes the calculations. Also, notice that the functions are very general in regards to the output. No higher level function is specific enough to retrieve only one measure, such as the Gini coefficient, or the median, or the quantiles of the distribution. If you need to add or modify one particular distributive measure, you must do it in functions inside <code>wbpip::md_compute_dist_stats()</code>, making sure the new output does not mess up the execution of any of the intermediate functions before the results get to <code>db_compute_dist_stats()</code>.</p>
<p><img src="img/pipdm_structure.png" id="pipdm-structure" /></p>
<p>This long chain of functions is inflexible and makes debugging very difficult. So, if you need to make any modification, first identify the chain of execution in each <code>pipdm</code> function you modify, and then make sure your changes do not affect the output format as it may break the execution chain. This is also a good example of why this structure needs to be improved.</p>
</div>
<div id="updating-pipdm-or-any-other-pip-package" class="section level3 hasAnchor" number="9.5.2">
<h3><span class="header-section-number">9.5.2</span> Updating <code>{pipdm}</code> (or any other PIP package)<a href="pcpipeline.html#updating-pipdm-or-any-other-pip-package" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As explained above, if you need to modify any function in <code>pipdm</code> or in <code>wbpip</code>, you need to make sure that the output does not conflict with the execution chain. Additionally, If you update any of the packages developed by the PIP team, make sure you always increased the version of the package using the function <code>usethis::use_version()</code>. Even if the change in the package is small, you need to increase the version of the package. Otherwise, <code>{targets}</code> won’t execute the sections of the pipeline that run the functions you changed. Finally as explained in the <a href="pcpipeline.html#prerequisites">Prerequisites</a>, if you are working on a branch different than master, make sure you install that version of the package before running the pipeline.</p>
</div>
</div>
<div id="executing-the-_targets.r-file" class="section level2 hasAnchor" number="9.6">
<h2><span class="header-section-number">9.6</span> Executing the <code>_targets.R</code> file<a href="pcpipeline.html#executing-the-_targets.r-file" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>.Rprofile</code> at the root of the directory makes sure that both <code>{targets}</code> and <code>{tarchetypes}</code> are loaded when the project is started. The whole pipeline execution might be very time consuming because it still needs to load all the data in the network drive. If you use a desktop remote connection the execution might be faster than running it locally, but it is still very time consuming. So, it is advisable to only execute the targets that are directly affected by your changes and manually check that everything looks ok. After that, you can execute the entire code confidently and leave it running overnight.</p>
<p>In order to execute the whole pipeline, you only need to type the directive <code>tar_make()</code> in the console. If you want to execute only one target, then type the name of the target in the same directive, e.g., <code>tar_make(dl_dist_stats)</code>. Keep in mind that if the inputs of prior targets to the objective target have changed, those targets will be executed first.</p>
</div>
<div id="debugging" class="section level2 hasAnchor" number="9.7">
<h2><span class="header-section-number">9.7</span> Debugging<a href="pcpipeline.html#debugging" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Debugging in targets is not easy. Yet, there are two ways to do it. The first way is provided in the chapter <a href="https://books.ropensci.org/targets/debugging.html">Debugging</a> of the Targets Manual. It provides clear instruction on how to debug <em>while still being in the pipeline</em>, but it could be the case that you don’t find this method flexible to dig deep enough into the problem. Alternatively, you could debug by stepping out of the pipeline a little bit and gain more flexibility, as described below.</p>
<p>Debugging is needed in one of two cases: one, because you got an error when running the pipeline with <code>tar_make()</code> or, two, because your results are odd. In either case, you should probably have an idea–though not always–of where the problem is. If the problem is an error in the execution of the pipeline, <code>{targets}</code> printed messages are usually informative.</p>
<div id="debugging-stem-targets" class="section level3 unnumbered hasAnchor">
<h3>Debugging stem targets<a href="pcpipeline.html#debugging-stem-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s see a simple example. Assume the problem is in the target <code>dt_dist_stats</code>, which is created by executing the function <code>db_create_dist_table</code> of the <code>{pipdm}</code> package. Since the problem is in there, all the targets and inputs necessary to create <code>dt_dist_stats</code> should be available in the <code>_targets/</code> data store. So, you can load them using <code>tar_load()</code> and execute the function in debugging mode. Like this,</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="pcpipeline.html#cb46-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-2"><a href="pcpipeline.html#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(dl_dist_stats)</span>
<span id="cb46-3"><a href="pcpipeline.html#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(svy_mean_ppp_table)</span>
<span id="cb46-4"><a href="pcpipeline.html#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(cache_inventory)</span>
<span id="cb46-5"><a href="pcpipeline.html#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="pcpipeline.html#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">debugonce</span>(pipdm<span class="sc">::</span>db_create_dist_table)</span>
<span id="cb46-7"><a href="pcpipeline.html#cb46-7" aria-hidden="true" tabindex="-1"></a>pipdm<span class="sc">::</span><span class="fu">db_create_dist_table</span>(</span>
<span id="cb46-8"><a href="pcpipeline.html#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">dl        =</span> dl_dist_stats,</span>
<span id="cb46-9"><a href="pcpipeline.html#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dsm_table =</span> svy_mean_ppp_table, </span>
<span id="cb46-10"><a href="pcpipeline.html#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">crr_inv   =</span> cache_inventory</span>
<span id="cb46-11"><a href="pcpipeline.html#cb46-11" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>Note that you must use the <code>::</code> because the environment in which <code>{targets}</code> runs is different from your global environment, in which you might not have attached all the libraries.</p>
</div>
<div id="debugging-branch-targets" class="section level3 unnumbered hasAnchor">
<h3>Debugging branch targets<a href="pcpipeline.html#debugging-branch-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The challenge debugging branch targets is that if the problem is in a specific survey, you can’t access the “subtarget” using the survey ID, or something of that nature, because the name of the subtarget is created by <code>{targets}</code> using a random number. This requires a little more of work.</p>
<p>Imagine now that the distributive measures of IDN 2015 are wrong. You see the pipeline and notice that these calculations are executed in target <code>dl_dist_stats</code>, which is the branch target created over <strong>all the cache files!</strong> It would look like something like this:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="pcpipeline.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb47-2"><a href="pcpipeline.html#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name      =</span> dl_dist_stats,</span>
<span id="cb47-3"><a href="pcpipeline.html#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">command   =</span> <span class="fu">db_compute_dist_stats</span>(<span class="at">dt       =</span> cache, </span>
<span id="cb47-4"><a href="pcpipeline.html#cb47-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">mean     =</span> dl_mean, </span>
<span id="cb47-5"><a href="pcpipeline.html#cb47-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">pop      =</span> aux_pop, </span>
<span id="cb47-6"><a href="pcpipeline.html#cb47-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">cache_id =</span> cache_ids), </span>
<span id="cb47-7"><a href="pcpipeline.html#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern   =</span>  <span class="fu">map</span>(cache, dl_mean, cache_ids), </span>
<span id="cb47-8"><a href="pcpipeline.html#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="st">&quot;list&quot;</span></span>
<span id="cb47-9"><a href="pcpipeline.html#cb47-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>In order to find the problem in IDN 2015, this what you could do:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="pcpipeline.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb48-2"><a href="pcpipeline.html#cb48-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> pipload<span class="sc">::</span><span class="fu">pip_load_cache</span>(<span class="st">&quot;IDN&quot;</span>, <span class="dv">2015</span>, <span class="st">&quot;PC&quot;</span>)</span>
<span id="cb48-3"><a href="pcpipeline.html#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(dl_mean)</span>
<span id="cb48-4"><a href="pcpipeline.html#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(cache_ids)</span>
<span id="cb48-5"><a href="pcpipeline.html#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(aux_pop)</span>
<span id="cb48-6"><a href="pcpipeline.html#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="pcpipeline.html#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract corresponding mean and cache ID</span></span>
<span id="cb48-8"><a href="pcpipeline.html#cb48-8" aria-hidden="true" tabindex="-1"></a>idt      <span class="ot">&lt;-</span> <span class="fu">which</span>(cache_ids <span class="sc">==</span> <span class="fu">unique</span>(dt<span class="sc">$</span>cache_id))</span>
<span id="cb48-9"><a href="pcpipeline.html#cb48-9" aria-hidden="true" tabindex="-1"></a>cache_id <span class="ot">&lt;-</span> cache_ids[idt]</span>
<span id="cb48-10"><a href="pcpipeline.html#cb48-10" aria-hidden="true" tabindex="-1"></a>mean_i   <span class="ot">&lt;-</span> dl_mean[[idt]]</span>
<span id="cb48-11"><a href="pcpipeline.html#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="pcpipeline.html#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Esecute the function of interest</span></span>
<span id="cb48-13"><a href="pcpipeline.html#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="fu">debugonce</span>(pipdm<span class="sc">:::</span>compute_dist_stats)</span>
<span id="cb48-14"><a href="pcpipeline.html#cb48-14" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">&lt;-</span> pipdm<span class="sc">::</span><span class="fu">db_compute_dist_stats</span>(<span class="at">dt       =</span> dt, </span>
<span id="cb48-15"><a href="pcpipeline.html#cb48-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">mean     =</span> mean_i, </span>
<span id="cb48-16"><a href="pcpipeline.html#cb48-16" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">pop      =</span> aux_pop, </span>
<span id="cb48-17"><a href="pcpipeline.html#cb48-17" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cache_id =</span> cache_id)</span></code></pre></div>
<p>First, you load all the inputs. Since target <code>dl_mean</code> is a relatively light object, we load it directly from the <code>_targets/</code> data store. Targets <code>cache_ids</code> and <code>aux_pop</code> are data frames, not lists, so we also load them from memory. The microdata, however, is problematic because target <code>cache</code>, which is the one that is parsed to create the <strong>actual</strong> <code>dl_dist_stata</code> target, is a huge list with all the micro, grouped, and imputed data. The solution is then to load the data frame of interest, using either <code>pipload</code> or <code>fst</code>.</p>
<p>Secondly, we need to filter the list <code>dl_mean</code> and the data frame <code>cache_ids</code> to parse only the information accepted by the <code>pipdm::db_compute_dist_stats()</code> function. This has to be done when debugging because in the actual target this is done iteratively in <code>pattern   =  map(cache, dl_mean, cache_ids)</code>.</p>
<p>Finally, you execute the function of interest. Notice something else. The target <code>aux_pop</code> is parsed as a single data frame because <code>pipdm::db_compute_dist_stats()</code> requires it that way. This is also one of the reasons why these functions in <code>{pipdm}</code> need some fixing and consistency in the format of the their inputs.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="auxiliary-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="tmpipelilne.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/PIP-Technical-Team/PIPmanual/edit/master/pc_pipeline.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["PIPmanual.pdf", "PIPmanual.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
