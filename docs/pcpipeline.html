<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual</title>
  <meta name="description" content="This is a manual to document all the technical and methodological decisions taken during the creation of packges for the PIP workflow." />
  <meta name="generator" content="bookdown 0.21.4 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a manual to document all the technical and methodological decisions taken during the creation of packges for the PIP workflow." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual" />
  
  <meta name="twitter:description" content="This is a manual to document all the technical and methodological decisions taken during the creation of packges for the PIP workflow." />
  

<meta name="author" content="DECIS" />
<meta name="author" content="Poverty GP" />


<meta name="date" content="2021-05-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="load.html"/>
<link rel="next" href="references.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">PIP Manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="load.html"><a href="load.html"><i class="fa fa-check"></i><b>2</b> Load microdata and Auxiliary data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="load.html"><a href="load.html#auxiilary-data"><i class="fa fa-check"></i><b>2.1</b> Auxiilary data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="load.html"><a href="load.html#udpate-data"><i class="fa fa-check"></i><b>2.1.1</b> udpate data</a></li>
<li class="chapter" data-level="2.1.2" data-path="load.html"><a href="load.html#load-data"><i class="fa fa-check"></i><b>2.1.2</b> Load data</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="load.html"><a href="load.html#microdata"><i class="fa fa-check"></i><b>2.2</b> Microdata</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="load.html"><a href="load.html#inventory-file"><i class="fa fa-check"></i><b>2.2.1</b> Inventory file</a></li>
<li class="chapter" data-level="2.2.2" data-path="load.html"><a href="load.html#finding-data"><i class="fa fa-check"></i><b>2.2.2</b> Finding data</a></li>
<li class="chapter" data-level="2.2.3" data-path="load.html"><a href="load.html#loading-data"><i class="fa fa-check"></i><b>2.2.3</b> Loading data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="pcpipeline.html"><a href="pcpipeline.html"><i class="fa fa-check"></i><b>3</b> Poverty Calculator Pipeline (pre-computed estimations)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="pcpipeline.html"><a href="pcpipeline.html#folder-structure"><i class="fa fa-check"></i><b>3.1</b> Folder structure</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#folders"><i class="fa fa-check"></i>Folders</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#files"><i class="fa fa-check"></i>Files</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="pcpipeline.html"><a href="pcpipeline.html#prerequisites-1"><i class="fa fa-check"></i><b>3.2</b> Prerequisites</a></li>
<li class="chapter" data-level="3.3" data-path="pcpipeline.html"><a href="pcpipeline.html#structure-of-the-_targets.r-file"><i class="fa fa-check"></i><b>3.3</b> Structure of the <code>_targets.R</code> file</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#start-up"><i class="fa fa-check"></i>Start up</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#step-1-small-functions"><i class="fa fa-check"></i>Step 1: small functions</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#pipe-prepare-data"><i class="fa fa-check"></i>Step 2: prepare data</a></li>
<li class="chapter" data-level="3.3.1" data-path="pcpipeline.html"><a href="pcpipeline.html#step-3-the-actual-pipeline"><i class="fa fa-check"></i><b>3.3.1</b> Step 3: The actual pipeline</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="pcpipeline.html"><a href="pcpipeline.html#understanding-the-pipeline"><i class="fa fa-check"></i><b>3.4</b> Understanding the pipeline</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#stem-targets"><i class="fa fa-check"></i>Stem targets</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#branches-targets"><i class="fa fa-check"></i>Branches targets</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#creating-the-cache-files"><i class="fa fa-check"></i>Creating the cache files</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="pcpipeline.html"><a href="pcpipeline.html#understanding-pipdm-functions"><i class="fa fa-check"></i><b>3.5</b> Understanding <code>{pipdm}</code> functions</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="pcpipeline.html"><a href="pcpipeline.html#internal-structure-of-pipdm-functions"><i class="fa fa-check"></i><b>3.5.1</b> Internal structure of <code>{pipdm}</code> functions</a></li>
<li class="chapter" data-level="3.5.2" data-path="pcpipeline.html"><a href="pcpipeline.html#updating-pipdm-or-any-other-pip-package"><i class="fa fa-check"></i><b>3.5.2</b> Updating <code>{pipdm}</code> (or any other PIP package)</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="pcpipeline.html"><a href="pcpipeline.html#executing-the-_targets.r-file"><i class="fa fa-check"></i><b>3.6</b> Executing the <code>_targets.R</code> file</a></li>
<li class="chapter" data-level="3.7" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging"><i class="fa fa-check"></i><b>3.7</b> Debugging</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">PIP Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="pcpipeline" class="section level1" number="3">
<h1><span class="header-section-number">Chapter 3</span> Poverty Calculator Pipeline (pre-computed estimations)</h1>
<p>The Poverty Calculator Pipeline–hereafter, and only for the rest of this
chapter, <strong>pc pipeline</strong>–is the technical procedure to calculate the
pre-computed estimations of the PIP project. These estimations have two main
purposes:</p>
<ol style="list-style-type: decimal">
<li>Provide the user with instantaneous information about distributive measures
of all the household surveys in the PIP repository that do not depend on the
value of the poverty line. Avoiding thus the need for re-computation as it
was the case in PovcalNet for some of these measures.</li>
<li>Provide the necessary inputs to the PIP API.</li>
</ol>
<p>This chapter walks you through the folder structure of the folder, the main R
script, <code>_targets.R</code>, and the complete and partial execution of the script.
Also, it provides some tips for debugging.</p>
<div id="folder-structure" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Folder structure</h2>
<p>The pc pipeline is hosted in the Github repository
<a href="https://github.com/PIP-Technical-Team/pip_ingestion_pipeline">PIP-Technical-Team/pip_ingestion_pipeline</a>.
At the root of the repo you will find a series of files and folders.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="pcpipeline.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- batch</span></span>
<span id="cb9-2"><a href="pcpipeline.html#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- pip_ingestion_pipeline.Rproj</span></span>
<span id="cb9-3"><a href="pcpipeline.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- R</span></span>
<span id="cb9-4"><a href="pcpipeline.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- README.md</span></span>
<span id="cb9-5"><a href="pcpipeline.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- renv</span></span>
<span id="cb9-6"><a href="pcpipeline.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- renv.lock</span></span>
<span id="cb9-7"><a href="pcpipeline.html#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- run.R</span></span>
<span id="cb9-8"><a href="pcpipeline.html#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- _packages.R</span></span>
<span id="cb9-9"><a href="pcpipeline.html#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; \-- _targets</span></span>
<span id="cb9-10"><a href="pcpipeline.html#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; \-- _targets.R</span></span></code></pre></div>
<div id="folders" class="section level3 unnumbered">
<h3>Folders</h3>
<ul>
<li><p><code>R</code> Contains long R functions used during the pipeline</p></li>
<li><p><code>batch</code> Script for timing the execution of the pipeline. This folder should
probably be removed</p></li>
<li><p><code>_targets</code> Folder for all objects created during the pipeline. You don’t
need to look inside as it content is managed by the <code>targets</code> package.</p></li>
<li><p><code>renv</code> Folder for reproducible environment.</p></li>
</ul>
</div>
<div id="files" class="section level3 unnumbered">
<h3>Files</h3>
<ul>
<li><p><code>_packages.R</code> Created by <code>targets::tar_renv()</code>. Do not modify manually.</p></li>
<li><p><code>_targets.R</code> Contains the pipeline. This is the most important file.</p></li>
</ul>
</div>
</div>
<div id="prerequisites-1" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Prerequisites</h2>
<p>Before you start working on the pc pipeline, you need to make sure to have the
following PIP packages.</p>
<p><span style="color:red">Note:</span> Notice that directives below have suffixes like
<code>@development</code>, which specify the branch of the particular package that you need
to use. Ideally, the master branch of all packages should be used, but that will
only happen until the end of the development process.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="pcpipeline.html#cb10-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/pipdm@development&quot;</span>)</span>
<span id="cb10-2"><a href="pcpipeline.html#cb10-2" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/pipload@development&quot;</span>)</span>
<span id="cb10-3"><a href="pcpipeline.html#cb10-3" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/wbpip@halfmedian_spl&quot;</span>)</span>
<span id="cb10-4"><a href="pcpipeline.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;joyn&quot;</span>)</span></code></pre></div>
<p>In case <code>renv</code> is not working for you, you may need to install all the packages
mentioned in the <code>_packages.R</code> script at the root of the folder. Also, make sure
to install the most recent version of <code>targets</code> and <code>tarchetypes</code> packages.</p>
</div>
<div id="structure-of-the-_targets.r-file" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Structure of the <code>_targets.R</code> file</h2>
<p>Even thought the pc pipeline script looks like a regular R Script, it is
structured in a specific way in order to make it work with
<code>{[targets](https://docs.ropensci.org/targets/)}</code> package, starting by the fact
that it must be called <code>_targets.R</code> in the root of the project. It highly
recommended you read the entire <a href="https://books.ropensci.org/targets/">targets
manual</a> to fully understand how it works.
Also, during this chapter, we will referring to the manual constantly to expand
in any particular targets’ concept.</p>
<div id="start-up" class="section level3 unnumbered">
<h3>Start up</h3>
<p>The first part of the pipeline sets up the environment. It,</p>
<ol style="list-style-type: decimal">
<li>loads the <code>{targets}</code> and <code>{tarchetypes}</code> packages,</li>
<li>creates default values like directories, time stamps, survey and reference
years boundaries, compression level of .fst files, among other things.</li>
<li>executes <code>tar_option_set()</code> to set up some option in <code>{targets}</code>. Two
particular options are important, <code>packages</code> and <code>imports</code> for tracking
changes in package dependencies. You can read more about it in sections
<a href="https://books.ropensci.org/targets/practices.html#loading-and-configuring-r-packages">Loading and configuring R
packages</a>
and <a href="https://books.ropensci.org/targets/practices.html#packages-based-invalidation">Packages-based
invalidation</a>
of the targets manual.</li>
<li>Attach all the packages and functions of the project by running
<code>source('_packages.R')</code> and <code>source('R/_common.R')</code></li>
</ol>
</div>
<div id="step-1-small-functions" class="section level3 unnumbered">
<h3>Step 1: small functions</h3>
<p>According to the section <a href="https://books.ropensci.org/targets/functions.html#functions-in-pipelines">Functions in
pipelines</a>
of the targets manual, it is recommend to only use functions rather than
expressions during the executions. Presumably, the reason for this is that
targets track changes in functions but not in expressions. Thus, this section of
the scripts defines small functions that are executed along the pc pipeline. In
the section above, the scripts <code>source('R/_common.R')</code> loads longer functions.
Yet, keep in mind that the <code>'R/_common.R'</code> was used in a previous version of the
pc pipeline before <code>{targets}</code> was implemented. Now, most of the function in
<code>'R/_common.R'</code> are included in the <code>{pipdm}</code> package.</p>
</div>
<div id="pipe-prepare-data" class="section level3 unnumbered">
<h3>Step 2: prepare data</h3>
<p>This section used to longer in previous versions of the pc pipeline because
identified the auxiliary data, loaded he PIP microdata inventory, and created
the cache files. Now, it only identifies the auxiliary data and creates the data
frame <code>aux_tb</code>, which is used inside the pc pipeline to create targets for each
auxiliary file. Not much more to say here.</p>
</div>
<div id="step-3-the-actual-pipeline" class="section level3" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Step 3: The actual pipeline</h3>
<p>This part of the pc pipeline is long and it is explained in detail in the next
section. Suffice is to say that the order of the pc pipeline is the following,</p>
<ol style="list-style-type: decimal">
<li><p>Load all necessary data. That is, auxiliary data and inventories, and then
create any cache fie that has not been created yet.</p></li>
<li><p>Calculate means in LCU</p></li>
<li><p>Crate deflated survey mean (DSM) table</p></li>
<li><p>Calculate reference year table (aka., interpolated means table)</p></li>
<li><p>Calculate distributional stats</p></li>
<li><p>Create output tables</p>
<ol style="list-style-type: decimal">
<li><p>join survey mean table with dist table</p></li>
<li><p>join reference year table with dist table</p></li>
<li><p>coverage table aggregate population at the regional level table</p></li>
</ol></li>
<li><p>Clean and save.</p></li>
</ol>
</div>
</div>
<div id="understanding-the-pipeline" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Understanding the pipeline</h2>
<p>One thing is to understand the how the <code>{targets}</code> package works and something
else is to understand how the targets of the Poverty Calculator pc pipeline are
created. For the former, you can read the targets manual. For the latter, we
should start by making a distinction between the different types of targets.</p>
<p>In <code>{targets}</code> terminology, there are two kinds of targets, <strong>stems</strong> and
<strong>branches</strong>. <strong>Stems</strong> are unitary targets. That is, for each target there is
only one single R object. <strong>Branches</strong>, on the other hand, are targets that
contain several objects or <em>subtargets</em> inside (You can learn more about them in
the chapter <a href="https://books.ropensci.org/targets/dynamic.html#dynamic">Dynamic
branching</a> of the
targets manual). We will see the use of this type of targets when we talk about
the use of cache files.</p>
<div id="stem-targets" class="section level3 unnumbered">
<h3>Stem targets</h3>
<p>There are two ways to create <strong>stem</strong> targets: either using <code>tar_target()</code> or
using <code>tar_map()</code> from the <code>{tarchetypes}</code> package. The <code>tar_map()</code> function
allows to create <strong>stem</strong> targets iteratively. See for instance the creation of
targets for each auxiliary data,</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="pcpipeline.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_map</span>(</span>
<span id="cb11-2"><a href="pcpipeline.html#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> aux_tb, </span>
<span id="cb11-3"><a href="pcpipeline.html#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">names  =</span> <span class="st">&quot;auxname&quot;</span>, </span>
<span id="cb11-4"><a href="pcpipeline.html#cb11-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-5"><a href="pcpipeline.html#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create dynamic name</span></span>
<span id="cb11-6"><a href="pcpipeline.html#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb11-7"><a href="pcpipeline.html#cb11-7" aria-hidden="true" tabindex="-1"></a>    aux_dir,</span>
<span id="cb11-8"><a href="pcpipeline.html#cb11-8" aria-hidden="true" tabindex="-1"></a>    auxfiles, </span>
<span id="cb11-9"><a href="pcpipeline.html#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">&quot;file&quot;</span></span>
<span id="cb11-10"><a href="pcpipeline.html#cb11-10" aria-hidden="true" tabindex="-1"></a>  ), </span>
<span id="cb11-11"><a href="pcpipeline.html#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb11-12"><a href="pcpipeline.html#cb11-12" aria-hidden="true" tabindex="-1"></a>    aux,</span>
<span id="cb11-13"><a href="pcpipeline.html#cb11-13" aria-hidden="true" tabindex="-1"></a>    pipload<span class="sc">::</span><span class="fu">pip_load_aux</span>(<span class="at">file_to_load =</span> aux_dir,</span>
<span id="cb11-14"><a href="pcpipeline.html#cb11-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">apply_label =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-15"><a href="pcpipeline.html#cb11-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-16"><a href="pcpipeline.html#cb11-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-17"><a href="pcpipeline.html#cb11-17" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><code>tar_map()</code> takes the values in the data frame <code>aux_tb</code> created in <a href="pcpipeline.html#pipe-prepare-data">Step 2:
prepare data</a> and creates two type of targets. First, it
create the target <code>aux_dir</code>, using the file paths in column <code>auxfiles</code> of
<code>aux_tb</code> to let <code>{targets}</code> know that we will have objects that are loaded from
a file and are not created inside the pc pipeline. This is why we use the option
<code>format = "file"</code>. Then, it uses the the column <code>auxname</code> of <code>aux_tb</code> as the
names of the targets for each auxiliary data frame (prefixed by the word “aux”).
This is why we had to add the argument <code>file_to_load</code> to
<code>pipload::pip_load_aux</code>, so we can let <code>{targets}</code> know that the file paths
defined in target <code>aux_dir</code> are used to create the targets prefixed with <code>aux</code>,
which are the actual targets. For example, if I need to use the population data
frame inside the pc pipeline, I’d use the target <code>aux_pop</code>, which had a
corresponding file path in <code>aux_dir</code>. In this way, if the original file
referenced in <code>aux_dir</code> changes, all the targets that depend on <code>aux_pop</code> will
be run again.</p>
</div>
<div id="branches-targets" class="section level3 unnumbered">
<h3>Branches targets</h3>
<p>Most of the targets created in the pc pipeline are <strong>branch</strong> targets. This is
so because, instead of loading all the datasets at once (drying out the
computer’s memory), we load each data independently, perform the calculations in
each data set, store all the results in a list, and then create a data frame
from that list, compiling all the results in one single object. Thus, if every
single data set or result were a <strong>stem</strong> target, it would be not only
impossible to visualize, but also more difficult to code. The following example
illustrates how it works,</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="pcpipeline.html#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="pcpipeline.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># step A</span></span>
<span id="cb12-3"><a href="pcpipeline.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb12-4"><a href="pcpipeline.html#cb12-4" aria-hidden="true" tabindex="-1"></a>  cache_inventory_dir, </span>
<span id="cb12-5"><a href="pcpipeline.html#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cache_inventory_path</span>(),</span>
<span id="cb12-6"><a href="pcpipeline.html#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">&quot;file&quot;</span></span>
<span id="cb12-7"><a href="pcpipeline.html#cb12-7" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb12-8"><a href="pcpipeline.html#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="pcpipeline.html#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># step B</span></span>
<span id="cb12-10"><a href="pcpipeline.html#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb12-11"><a href="pcpipeline.html#cb12-11" aria-hidden="true" tabindex="-1"></a>  cache_inventory, </span>
<span id="cb12-12"><a href="pcpipeline.html#cb12-12" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb12-13"><a href="pcpipeline.html#cb12-13" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> fst<span class="sc">::</span><span class="fu">read_fst</span>(cache_inventory_dir, </span>
<span id="cb12-14"><a href="pcpipeline.html#cb12-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">as.data.table =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-15"><a href="pcpipeline.html#cb12-15" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb12-16"><a href="pcpipeline.html#cb12-16" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb12-17"><a href="pcpipeline.html#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="pcpipeline.html#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># step C</span></span>
<span id="cb12-19"><a href="pcpipeline.html#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(cache_files,</span>
<span id="cb12-20"><a href="pcpipeline.html#cb12-20" aria-hidden="true" tabindex="-1"></a>           <span class="fu">get_cache_files</span>(cache_inventory)),</span>
<span id="cb12-21"><a href="pcpipeline.html#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="pcpipeline.html#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># step D</span></span>
<span id="cb12-23"><a href="pcpipeline.html#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_files</span>(cache_dir, cache_files),</span>
<span id="cb12-24"><a href="pcpipeline.html#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="pcpipeline.html#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># step E</span></span>
<span id="cb12-26"><a href="pcpipeline.html#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(cache, </span>
<span id="cb12-27"><a href="pcpipeline.html#cb12-27" aria-hidden="true" tabindex="-1"></a>           fst<span class="sc">::</span><span class="fu">read_fst</span>(<span class="at">path =</span> cache_dir, </span>
<span id="cb12-28"><a href="pcpipeline.html#cb12-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">as.data.table =</span> <span class="cn">TRUE</span>), </span>
<span id="cb12-29"><a href="pcpipeline.html#cb12-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="fu">map</span>(cache_dir), </span>
<span id="cb12-30"><a href="pcpipeline.html#cb12-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">iteration =</span> <span class="st">&quot;list&quot;</span>)</span></code></pre></div>
<p>The code above illustrates several things. It is divided in steps, being the
last step– step E–the part of the code in which we create the <strong>branch</strong>
target. Yet, it is important to understand the steps before.</p>
<p>In step A we create target <code>cache_inventory_dir</code>, which is merely the path of
the file than contains the cache inventory. Notice that it returned by function
and not entered directly into the target. Since it is a file path, we need to
add the argument <code>format = "file"</code> to let <code>{targets}</code> know that it is input
data. In step B we load the cache inventory file into target <code>cache_inventory</code>
by providing the target “path” that we created in step A. This file has several
column. One of them contains the file path of every single cache file in the PIP
network drive. That single column is extracted from the cache inventory in step
C. Now, in step D, each file path is declared as input, using the convenient
function <code>tar_files()</code>, creating thus a new target, <code>cache_dir</code>. FInally, we
create <strong>branch</strong> target <code>cache</code> with all the cache files by loading each file.
To do this iteratively, we parse the <code>cache_dir</code> target to the <code>path</code> argument
of the function <code>fst::read_fst()</code> and to the <code>pattern = map()</code> argument of the
<code>tar_target()</code> function. Finally, we need to specify that the output of the
iteration is stored as a list, using the argument <code>iteration = "list"</code>.</p>
<p>The basic logic of <strong>branch</strong> targets is that the vector or list to iterate
though should be added in the argument of the function and the <code>pattern = map()</code>
argument of the <code>tar_target()</code> function. it is very similar to <code>purrr::map()</code></p>
<p><span style="color:red">Note:</span> If we are iterating through <em>more than one</em> vector or
list, you need to (1) separate each of them by commas in the <code>map()</code> part of the
argument (See example code below). (2) make sure all the vectors or lists <strong>have
the same length</strong>. This is why we cannot remove NULL or NA values from any
target. (3) make sure you do <strong>NOT</strong> sort any of the output targets as it will
loose its correspondence with other targets.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="pcpipeline.html#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="pcpipeline.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Example of creating branch target using several lists to iterate through.</span></span>
<span id="cb13-3"><a href="pcpipeline.html#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb13-4"><a href="pcpipeline.html#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">name      =</span> dl_dist_stats,</span>
<span id="cb13-5"><a href="pcpipeline.html#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">command   =</span> <span class="fu">db_compute_dist_stats</span>(<span class="at">dt       =</span> cache, </span>
<span id="cb13-6"><a href="pcpipeline.html#cb13-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">mean     =</span> dl_mean, </span>
<span id="cb13-7"><a href="pcpipeline.html#cb13-7" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">pop      =</span> aux_pop, </span>
<span id="cb13-8"><a href="pcpipeline.html#cb13-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">cache_id =</span> cache_ids), </span>
<span id="cb13-9"><a href="pcpipeline.html#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern   =</span>  <span class="fu">map</span>(cache, dl_mean, cache_ids), </span>
<span id="cb13-10"><a href="pcpipeline.html#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iteration =</span> <span class="st">&quot;list&quot;</span></span>
<span id="cb13-11"><a href="pcpipeline.html#cb13-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="creating-the-cache-files" class="section level3 unnumbered">
<h3>Creating the cache files</h3>
<p>The creation of the cache files is done in the following code,</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="pcpipeline.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(pipeline_inventory, {</span>
<span id="cb14-2"><a href="pcpipeline.html#cb14-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> pipdm<span class="sc">::</span><span class="fu">db_filter_inventory</span>(</span>
<span id="cb14-3"><a href="pcpipeline.html#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">dt =</span> pip_inventory,</span>
<span id="cb14-4"><a href="pcpipeline.html#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pfw_table =</span> aux_pfw)</span>
<span id="cb14-5"><a href="pcpipeline.html#cb14-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-6"><a href="pcpipeline.html#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uncomment for specific countries</span></span>
<span id="cb14-7"><a href="pcpipeline.html#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># x &lt;- x[country_code == &#39;IDN&#39; &amp; surveyid_year == 2015]</span></span>
<span id="cb14-8"><a href="pcpipeline.html#cb14-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-9"><a href="pcpipeline.html#cb14-9" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb14-10"><a href="pcpipeline.html#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(status_cache_files_creation, </span>
<span id="cb14-11"><a href="pcpipeline.html#cb14-11" aria-hidden="true" tabindex="-1"></a>           pipdm<span class="sc">::</span><span class="fu">create_cache_file</span>(</span>
<span id="cb14-12"><a href="pcpipeline.html#cb14-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">pipeline_inventory =</span> pipeline_inventory,</span>
<span id="cb14-13"><a href="pcpipeline.html#cb14-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">pip_data_dir       =</span> PIP_DATA_DIR,</span>
<span id="cb14-14"><a href="pcpipeline.html#cb14-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">tool               =</span> <span class="st">&quot;PC&quot;</span>,</span>
<span id="cb14-15"><a href="pcpipeline.html#cb14-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">cache_svy_dir      =</span> CACHE_SVY_DIR,</span>
<span id="cb14-16"><a href="pcpipeline.html#cb14-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">compress           =</span> FST_COMP_LVL,</span>
<span id="cb14-17"><a href="pcpipeline.html#cb14-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">force              =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-18"><a href="pcpipeline.html#cb14-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">verbose            =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-19"><a href="pcpipeline.html#cb14-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">cpi_dt             =</span> aux_cpi,</span>
<span id="cb14-20"><a href="pcpipeline.html#cb14-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">ppp_dt             =</span> aux_ppp)</span>
<span id="cb14-21"><a href="pcpipeline.html#cb14-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>It is important to understand this part of the pc pipeline thoroughly because
the cache files used to be created in <a href="pcpipeline.html#pipe-prepare-data">Step 2: prepare data</a> rather than here.
Now, it has not only been integrated in the pc pipeline, but it is also possible
to execute the creation of cache files independently from the rest of the
pipeline, by following the instructions in [Executing the _targets.R file].</p>
<p>The first target, <code>pipeline_inventory</code> is the pip inventory dataset filtered to
match only the data available in the price framework file. This data set also
contains a lot information useful for creating the cache files. Notice that the
commented line in this target would filter the pipeline inventory to have only
the information for IDN, 2015. <span style="color:red">In case you need to update specific cache files,
you have to do add the proper filtering condition in there</span>.</p>
<p>In the second target, <code>status_cache_files_creation</code>, you will create the cache
files, but the returning value of the function <code>pipdm::create_cache_file()</code> is
not the cache file per-se but a list with the status of the process of creation.
If the creation of a particular file fails, it does not precludes the creation
of other files, but returns metadata of where in the process if failed. Notice
that function <code>pipdm::create_cache_file()</code> requires the the CPI and PPP
auxiliary data. This is so because the cache file has an additional variable,
<code>welfare_ppp</code>, for deflated welfare aggregate to daily 2011 PPP values. FInally,
and more importantly, argument <code>force = TRUE</code> ensures that even if the cache
file exists already, it should be modified. This is important when you require
additional features in the cache file from the then ones it has now. If set to
<code>TRUE</code>, it will replace any file in the network drive that is listed in
<code>pipeline_inventory</code>. If set to <code>FALSE</code>, only the files that are in
<code>pipeline_inventory</code> but not in the cache folder will be created. Use this
option only when you get need to add new features to all cache data or when you
are testing, and only need a few surveys with the new features.</p>
</div>
</div>
<div id="understanding-pipdm-functions" class="section level2" number="3.5">
<h2><span class="header-section-number">3.5</span> Understanding <code>{pipdm}</code> functions</h2>
<p>The <code>{pipdm}</code> package is the backbone of the pc pipeline. It is in charge of
executing the functions in <code>{wbpip}</code> and consolidate the new DataBases. This is
why, many of the functions in <code>{pipdm}</code> are prefixed with “db_.”</p>
<div id="internal-structure-of-pipdm-functions" class="section level3" number="3.5.1">
<h3><span class="header-section-number">3.5.1</span> Internal structure of <code>{pipdm}</code> functions</h3>
<p>The main objective of <code>{pipdm}</code> is to execute the functions in <code>{wbpip}</code> to do
the calculations and then build the data frames. As of today, 2021-05-06,
the process is a little intricate.</p>
<p>Let’s take the example of estimating distributive measures in the pipeline. The
image <a href="pcpipeline.html#pipdm-structure">below</a> shows that there are at least three intermediate
function levels between the <code>db_compute_dist_stats()</code> function, which executed
directly in the pc pipeline, and the <code>wbpip::md_compute_dist_stats()</code>, which
makes the calculations. Also, notice that the functions are very general in
regards to the output. No higher level function is specific enough to retrieve
only one measure such as the Gini coefficient, or the median, or the quantiles
of the distribution. If we need to add or modify one particular distributive
measure, it must be done an even lower level than
<code>wbpip::md_compute_dist_stats()</code> and make sure the new output does not mess up
the execution of any of the intermediate functions before the results get to
<code>db_compute_dist_stats()</code>.</p>
<p><img src="img/pipdm_structure.png" id="pipdm-structure" /></p>
<p>This long chain of functions is inflexible and makes debugging very difficult.
So, if you need to make any modification, identify first the chain of execution
in each <code>pipdm</code> function you modify and then make sure your changes do not
affect the output format as it may break the chain of execution. Also, this is a
good example why, this structure might need be improved.</p>
</div>
<div id="updating-pipdm-or-any-other-pip-package" class="section level3" number="3.5.2">
<h3><span class="header-section-number">3.5.2</span> Updating <code>{pipdm}</code> (or any other PIP package)</h3>
<p>As explained above, if you need to modify any function in <code>pipdm</code> or in <code>wbpip</code>
you need to make sure that the output does not conflict with the chain of
execution. Additionally, If you update any of the packages developed by the PIP
team, make sure you always increased the version of the package using the
function <code>usethis::use_version()</code>. Even if the change in the package is small,
you need to increase the version of the package. Otherwise, <code>{targets}</code> won’t
execute the sections of the pipeline that run the functions you changed. Finally
as explained in the <a href="pcpipeline.html#prerequisites-1">Prerequisites</a>, if you are working on a branch different
than master, make sure you install that version of the package before running
the targets.</p>
</div>
</div>
<div id="executing-the-_targets.r-file" class="section level2" number="3.6">
<h2><span class="header-section-number">3.6</span> Executing the <code>_targets.R</code> file</h2>
<p>The <code>.Rprofile</code> in the root of the directory makes sure that both <code>{targets}</code>
and <code>{tarchetypes}</code> are loaded when the project is started. The execution of the
whole pipeline might very time consuming because it is still needs to load all
the data in the network drive. If you use a desktop remote connection the
execution might be faster than running locally, but it is still very time
consuming. So, my advise is that you only execute the targets that are directly
affect by your changes and manually check that everything looks ok. After that,
you can execute the whole thing confidently.</p>
<p>In order to execute the whole pipeline, you only need to type directive
<code>tar_make()</code> in the console. If you want to execute only one target, then type
the name of the target in the same directive, e.g., <code>tar_make(dl_dist_stats)</code>.
Keep in mind that if the inputs of prior targets to the objective target have
changed, those targets will be executed first.</p>
</div>
<div id="debugging" class="section level2" number="3.7">
<h2><span class="header-section-number">3.7</span> Debugging</h2>
<p>Debugging in targets is not easy. Yet, there are two ways to do it. On the one
hand, you can take a look at the chapter
<a href="https://books.ropensci.org/targets/debugging.html">Debugging</a> in the Targets
Manual. It provides clear instruction on how to do it. On the other hand, you
can see if the following ideas work.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="load.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["PIPmanual.pdf", "PIPmanual.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
