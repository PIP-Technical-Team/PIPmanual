<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual</title>
  <meta name="description" content="This is a manual to document all the technical and methodological decisions taken during the creation of packges for the PIP workflow." />
  <meta name="generator" content="bookdown 0.21.4 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a manual to document all the technical and methodological decisions taken during the creation of packges for the PIP workflow." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Poverty Calculator Pipeline (pre-computed estimations) | PIP Manual" />
  
  <meta name="twitter:description" content="This is a manual to document all the technical and methodological decisions taken during the creation of packges for the PIP workflow." />
  

<meta name="author" content="DECIS" />
<meta name="author" content="Poverty GP" />


<meta name="date" content="2021-05-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="load.html"/>
<link rel="next" href="references.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">PIP Manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="load.html"><a href="load.html"><i class="fa fa-check"></i><b>2</b> Load microdata and Auxiliary data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="load.html"><a href="load.html#auxiilary-data"><i class="fa fa-check"></i><b>2.1</b> Auxiilary data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="load.html"><a href="load.html#udpate-data"><i class="fa fa-check"></i><b>2.1.1</b> udpate data</a></li>
<li class="chapter" data-level="2.1.2" data-path="load.html"><a href="load.html#load-data"><i class="fa fa-check"></i><b>2.1.2</b> Load data</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="load.html"><a href="load.html#microdata"><i class="fa fa-check"></i><b>2.2</b> Microdata</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="load.html"><a href="load.html#inventory-file"><i class="fa fa-check"></i><b>2.2.1</b> Inventory file</a></li>
<li class="chapter" data-level="2.2.2" data-path="load.html"><a href="load.html#finding-data"><i class="fa fa-check"></i><b>2.2.2</b> Finding data</a></li>
<li class="chapter" data-level="2.2.3" data-path="load.html"><a href="load.html#loading-data"><i class="fa fa-check"></i><b>2.2.3</b> Loading data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="pcpipeline.html"><a href="pcpipeline.html"><i class="fa fa-check"></i><b>3</b> Poverty Calculator Pipeline (pre-computed estimations)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="pcpipeline.html"><a href="pcpipeline.html#folder-structure"><i class="fa fa-check"></i><b>3.1</b> Folder structure</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#folders"><i class="fa fa-check"></i>Folders</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#files"><i class="fa fa-check"></i>Files</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="pcpipeline.html"><a href="pcpipeline.html#prerequisites-1"><i class="fa fa-check"></i><b>3.2</b> Prerequisites</a></li>
<li class="chapter" data-level="3.3" data-path="pcpipeline.html"><a href="pcpipeline.html#structure-of-the-_targets.r-file"><i class="fa fa-check"></i><b>3.3</b> Structure of the <code>_targets.R</code> file</a>
<ul>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#start-up"><i class="fa fa-check"></i>Start up</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#step-1-small-functions"><i class="fa fa-check"></i>Step 1: small functions</a></li>
<li class="chapter" data-level="" data-path="pcpipeline.html"><a href="pcpipeline.html#step-2-prepare-data"><i class="fa fa-check"></i>Step 2: prepare data</a></li>
<li class="chapter" data-level="3.3.1" data-path="pcpipeline.html"><a href="pcpipeline.html#step-3-the-actual-pipeline"><i class="fa fa-check"></i><b>3.3.1</b> Step 3: The actual pipeline</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="pcpipeline.html"><a href="pcpipeline.html#executing-the-_targets.r-file"><i class="fa fa-check"></i><b>3.4</b> Executing the <code>_targets.R</code> file</a></li>
<li class="chapter" data-level="3.5" data-path="pcpipeline.html"><a href="pcpipeline.html#debugging"><i class="fa fa-check"></i><b>3.5</b> Debugging</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">PIP Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="pcpipeline" class="section level1" number="3">
<h1><span class="header-section-number">Chapter 3</span> Poverty Calculator Pipeline (pre-computed estimations)</h1>
<p>The Poverty Calculator Pipeline–hereafter, and only for the rest of this
chapter, pipeline–is the technical procedure to calculate the pre-computed
estimations of the PIP project. These estimations have two main purposes:</p>
<ol style="list-style-type: decimal">
<li>Provide the user with instantaneous information about distributive measures
of all the household surveys in the PIP repository that do not depend on the
value of the poverty line. Avoiding thus the need for re-computation as it
was the case in PovcalNet for some of these measures.</li>
<li>Provide the necessary inputs to the PIP API.</li>
</ol>
<p>This chapter walks you through the folder structure of the folder, the main R
script, <code>_targets.R</code>, and the complete and partial execution of the script.
Also, it provides some tips for debugging.</p>
<div id="folder-structure" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Folder structure</h2>
<p>The pipeline is hosted in the Github repository
<a href="https://github.com/PIP-Technical-Team/pip_ingestion_pipeline">PIP-Technical-Team/pip_ingestion_pipeline</a>.
At the root of the repo you will find a series of files and folders.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="pcpipeline.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- batch</span></span>
<span id="cb9-2"><a href="pcpipeline.html#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- pip_ingestion_pipeline.Rproj</span></span>
<span id="cb9-3"><a href="pcpipeline.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- R</span></span>
<span id="cb9-4"><a href="pcpipeline.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- README.md</span></span>
<span id="cb9-5"><a href="pcpipeline.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- renv</span></span>
<span id="cb9-6"><a href="pcpipeline.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- renv.lock</span></span>
<span id="cb9-7"><a href="pcpipeline.html#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- run.R</span></span>
<span id="cb9-8"><a href="pcpipeline.html#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; +-- _packages.R</span></span>
<span id="cb9-9"><a href="pcpipeline.html#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; \-- _targets</span></span>
<span id="cb9-10"><a href="pcpipeline.html#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; \-- _targets.R</span></span></code></pre></div>
<div id="folders" class="section level3 unnumbered">
<h3>Folders</h3>
<ul>
<li><p><code>R</code> Contains long R functions used during the pipeline</p></li>
<li><p><code>batch</code> Script for timing the execution of the pipeline. This folder should
probably be removed</p></li>
<li><p><code>_targets</code> Folder for all objects created during the pipeline. You don’t
need to look inside as it content is managed by the <code>targets</code> package.</p></li>
<li><p><code>renv</code> Folder for reproducible environment.</p></li>
</ul>
</div>
<div id="files" class="section level3 unnumbered">
<h3>Files</h3>
<ul>
<li><p><code>_packages.R</code> Created by <code>targets::tar_renv()</code>. Do not modify manually.</p></li>
<li><p><code>_targets.R</code> Contains the pipeline. This is the most important file.</p></li>
</ul>
</div>
</div>
<div id="prerequisites-1" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Prerequisites</h2>
<p>Before you start working on the pipeline, you need to make sure to have the
following PIP packages.</p>
<p><span style="color:red">Note:</span> Notice that directives below have suffixes like
<code>@development</code>, which specify the branch of the particular package that you need
to use. Ideally, the master branch of all packages should be used, but that will
only happen until the end of the development process.</p>
<p><span style="color:red">Note2:</span> If you update any of the packages developed by the
PIP team, make sure you always increased the version of the package using the
function <code>usethis::use_version()</code>. Even if the change in the package is small,
you need on increased the version of the package. Otherwise, <code>{targets}</code> won’t
execute the sections of the pipeline that run the functions you changed.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="pcpipeline.html#cb10-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/pipdm@development&quot;</span>)</span>
<span id="cb10-2"><a href="pcpipeline.html#cb10-2" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/pipload@development&quot;</span>)</span>
<span id="cb10-3"><a href="pcpipeline.html#cb10-3" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;PIP-Technical-Team/wbpip@halfmedian_spl&quot;</span>)</span>
<span id="cb10-4"><a href="pcpipeline.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;joyn&quot;</span>)</span></code></pre></div>
<p>In case <code>renv</code> is not working for you, you may need to install all the packages
mentioned in the <code>_packages.R</code> script at the root of the folder. Also, make sure
to install the most recent version of <code>targets</code> and <code>tarchetypes</code> packages.</p>
</div>
<div id="structure-of-the-_targets.r-file" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Structure of the <code>_targets.R</code> file</h2>
<p>Even thought the pipeline script looks like a regular R Script, it is structured
in a specific way in order to make it work with
<code>{[targets](https://docs.ropensci.org/targets/)}</code> package, starting by the fact
that it must be called <code>_targets.R</code> in the root of the project. It highly
recommended you read the entire <a href="https://books.ropensci.org/targets/">targets
manual</a> to fully understand how it works.
Also, during this chapter, we will referring to the manual constantly to expand
in any particular targets’ concept.</p>
<div id="start-up" class="section level3 unnumbered">
<h3>Start up</h3>
<p>The first part of the pipeline sets up the environment. It,</p>
<ol style="list-style-type: decimal">
<li>loads the <code>{targets}</code> and <code>{tarchetypes}</code> packages,</li>
</ol>
<!-- -->
<ol start="2" style="list-style-type: decimal">
<li>creates default values like directories, time stamps, survey and reference
years boundaries, compression level of .fst files, among other things.</li>
<li>executes <code>tar_option_set()</code> to set up some option in <code>{targets}</code>. Two
particular options are important, <code>packages</code> and <code>imports</code> for tracking
changes in package dependencies. You can read more about it in sections
<a href="https://books.ropensci.org/targets/practices.html#loading-and-configuring-r-packages">Loading and configuring R
packages</a>
and <a href="https://books.ropensci.org/targets/practices.html#packages-based-invalidation">Packages-based
invalidation</a>
of the targets manual.</li>
<li>Attach all the packages and functions of the project by running
<code>source('_packages.R')</code> and <code>source('R/_common.R')</code></li>
</ol>
</div>
<div id="step-1-small-functions" class="section level3 unnumbered">
<h3>Step 1: small functions</h3>
<p>According to the section <a href="https://books.ropensci.org/targets/functions.html#functions-in-pipelines">Functions in
pipelines</a>
of the targets manual, it is recommend to only use functions rather than
expressions during the executions. Presumably, the reason for this is that
targets track changes in functions but not in expressions. Thus, this section of
the scripts defines small functions that are executed along the pipeline. In the
section above, the scripts <code>source('R/_common.R')</code> loads longer functions. Yet,
keep in mind that the <code>'R/_common.R'</code> was used in a previous version of the
pipeline before <code>{targets}</code> was implemented. Now, most of the function in
<code>'R/_common.R'</code> are included in the <code>{pipdm}</code> package.</p>
</div>
<div id="step-2-prepare-data" class="section level3 unnumbered">
<h3>Step 2: prepare data</h3>
<p>This section used to longer in previous versions of the pipeline because
identified the auxiliary data, loaded he PIP microdata inventory, and created
the cache files. Now, it only identifies the auxiliary data. Not much to be said
here.</p>
</div>
<div id="step-3-the-actual-pipeline" class="section level3" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Step 3: The actual pipeline</h3>
<p>This part of the pipeline is long and it is explained in detail in the next
section. Suffice is to say that the order of the pipeline is the following,</p>
<ol style="list-style-type: decimal">
<li><p>Load all necessary data. That is, auxiliary data and inventories, and then
create any cache fie that has not been created yet.</p></li>
<li><p>Calculate means in LCU</p></li>
<li><p>Crate deflated survey mean (DSM) table</p></li>
<li><p>Calculate reference year table (aka., interpolated means table)</p></li>
<li><p>Calculate distributional stats</p></li>
<li><p>Create output tables</p>
<ol style="list-style-type: decimal">
<li><p>join survey mean table with dist table</p></li>
<li><p>join reference year table with dist table</p></li>
<li><p>coverage table aggregate population at the regional level table</p></li>
</ol></li>
<li><p>Clean and save.</p></li>
</ol>
</div>
</div>
<div id="executing-the-_targets.r-file" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Executing the <code>_targets.R</code> file</h2>
<p>awfawef</p>
</div>
<div id="debugging" class="section level2" number="3.5">
<h2><span class="header-section-number">3.5</span> Debugging</h2>
<p>sdfsdf</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="load.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["PIPmanual.pdf", "PIPmanual.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
